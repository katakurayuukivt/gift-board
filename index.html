<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‚®ãƒ•ãƒˆãƒœãƒ¼ãƒ‰ç”»åƒç”Ÿæˆï¼ˆã‚¯ãƒªãƒ¼ãƒ³ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0e1218; --panel:#161b24; --muted:#9aa4b2; --line:#243041; --accent:#60a5fa;
      --btn:#1a2433; --ink:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:12px;border-bottom:1px solid var(--line)}
    header .info{display:flex;gap:8px;align-items:center}
    header .pill{background:#0b0f15;border:1px solid var(--line);border-radius:10px;padding:6px 10px;font-size:12px;color:var(--muted)}
    header input[type="text"]{background:#0b0f15;border:1px solid var(--line);color:#fff;border-radius:8px;padding:8px 10px;min-width:280px}
    header button{background:var(--accent);color:#0b1020;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    header .ghost{background:var(--btn);color:#c9d3e0}
    main{display:grid;grid-template-columns: 1fr 380px;gap:14px;padding:14px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    .title{font-weight:800;margin-bottom:10px}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .field input[type="text"], .field input[type="number"], .field select {background:#0b0f15;border:1px solid var(--line);color:#fff;border-radius:8px;padding:8px 10px}
    .field input[type="color"]{width:52px;height:34px;border:none;border-radius:6px;background:#0b0f15}
    .field .slider{width:100%}
    .live{background:#0b0f15;border:1px solid var(--line);border-radius:12px;height:560px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .live canvas{max-width:100%;max-height:100%}
    .list{display:grid;grid-template-columns:1fr;gap:8px;max-height:420px;overflow:auto}
    .gift{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:#0f1623;border:1px solid #2a3448;cursor:pointer}
    .slots{display:grid;grid-template-columns:1fr;gap:8px;max-height:340px;overflow:auto;margin-top:10px}
    .slotrow{display:flex;align-items:center;gap:10px;background:#0f1623;border:1px solid #2a3448;border-radius:12px;padding:8px 10px}
    .slotrow img{width:44px;height:44px;object-fit:contain;background:#0b0f15;border:1px solid #2a3448;border-radius:8px}
    .danger{color:#f87171;cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    .sep{height:1px;background:var(--line);margin:10px 0}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .btnline{display:flex;gap:8px;align-items:center}
    .note{margin-top:6px;color:var(--muted);font-size:12px}
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="info">
      <div class="pill">Sheet ID å›ºå®š</div>
      <div class="pill" id="sid">15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U</div>
      <div class="pill">gid å›ºå®š</div>
      <div class="pill" id="sgid">1487601753</div>
    </div>
    <div class="info">
      <input id="proxy" type="text" placeholder="ä»»æ„: CORSãƒ—ãƒ­ã‚­ã‚·URLï¼ˆä¾‹ https://api.allorigins.win/raw?url=ï¼‰">
      <button id="loadBtn" class="ghost">èª­ã¿è¾¼ã‚€</button>
    </div>
    <div class="info" style="margin-left:auto">
      <button id="pickBg" class="ghost">èƒŒæ™¯ç”»åƒã‚’é¸ã¶</button>
      <input id="bgFile" type="file" accept="image/*" style="display:none">
      <button id="saveBtn">PNGã¨ã—ã¦ä¿å­˜</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="title">ãƒ©ã‚¤ãƒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>

      <div class="grid2">
        <div class="field">
          <label>åˆ—ï¼ˆCOLSï¼‰</label>
          <input id="cols" type="number" value="6" min="1" max="12">
        </div>
        <div class="field">
          <label>è¡Œï¼ˆROWSï¼‰</label>
          <input id="rows" type="number" value="3" min="1" max="10">
        </div>

        <div class="field">
          <label>æ å¹… TILE_W</label>
          <input id="tileW" type="number" value="320" min="10" max="2000">
        </div>
        <div class="field">
          <label>æ é«˜ TILE_H</label>
          <input id="tileH" type="number" value="180" min="10" max="2000">
        </div>

        <div class="field">
          <label>æ é–“ GAP</label>
          <input id="gap" type="number" value="20" min="0" max="300">
        </div>
        <div class="field">
          <label>ä¸¸è§’ px</label>
          <input id="radius" type="number" value="18" min="0" max="200">
        </div>

        <div class="field">
          <label>å·¦ä¸Šã‚ªãƒ•ã‚»ãƒƒãƒˆ X</label>
          <input id="offX" type="number" value="0" min="-2000" max="2000">
        </div>
        <div class="field">
          <label>å·¦ä¸Šã‚ªãƒ•ã‚»ãƒƒãƒˆ Y</label>
          <input id="offY" type="number" value="0" min="-2000" max="2000">
        </div>

        <div class="field">
          <label>ã‚¢ã‚¤ã‚³ãƒ³å€ç‡ï¼ˆ% / ã‚¿ã‚¤ãƒ«åŸºæº–ï¼‰</label>
          <input id="iconScale" class="slider" type="range" min="30" max="200" value="100">
          <div class="muted">ç¾åœ¨: <span id="iconScaleView">100</span>%</div>
        </div>
        <div class="field">
          <label>ã‚¢ã‚¤ã‚³ãƒ³ä½™ç™½ pxï¼ˆæ ä¸­å¤®ã®ä½™ç™½ï¼‰</label>
          <input id="iconPad" type="number" value="14" min="0" max="200">
        </div>

        <div class="field">
          <label>ã¯ã¿å‡ºã—OKï¼ˆã‚¿ã‚¤ãƒ«å¤–ã¸ï¼‰</label>
          <select id="overflowOK">
            <option value="0">OFF</option>
            <option value="1">ON</option>
          </select>
        </div>
        <div class="field">
          <label>ã‚¬ã‚¤ãƒ‰æ æç”»</label>
          <select id="guideOn">
            <option value="1">ON</option>
            <option value="0">OFF</option>
          </select>
        </div>

        <div class="field">
          <label>ãƒ†ã‚­ã‚¹ãƒˆ</label>
          <input id="labelText" type="text" value="ãƒ†ã‚¹ãƒˆ">
        </div>
        <div class="field">
          <label>æ–‡å­—ã‚µã‚¤ã‚º px</label>
          <input id="labelSize" type="number" value="86" min="8" max="400">
        </div>

        <div class="field">
          <label>è‰²</label>
          <div class="btnline">
            <input id="labelColor" type="color" value="#ffffff">
            <label class="muted"><input id="labelStroke" type="checkbox" checked> ç¸</label>
            <input id="labelStrokeColor" type="color" value="#000000">
          </div>
        </div>
        <div class="field">
          <label>ãƒ†ã‚­ã‚¹ãƒˆä½ç½®</label>
          <div class="row3">
            <select id="labelH">
              <option value="left">å·¦</option>
              <option value="center" selected>ä¸­å¤®</option>
              <option value="right">å³</option>
            </select>
            <select id="labelV">
              <option value="top">ä¸Š</option>
              <option value="center" selected>ä¸­å¤®</option>
              <option value="bottom">ä¸‹</option>
            </select>
            <div></div>
          </div>
        </div>
        <div class="field">
          <label>æ–‡å­—ã‚ªãƒ•ã‚»ãƒƒãƒˆ X</label>
          <input id="labelDx" type="number" value="0" min="-2000" max="2000">
        </div>
        <div class="field">
          <label>æ–‡å­—ã‚ªãƒ•ã‚»ãƒƒãƒˆ Y</label>
          <input id="labelDy" type="number" value="0" min="-2000" max="2000">
        </div>
      </div>

      <div class="sep"></div>

      <div class="live">
        <canvas id="preview"></canvas>
      </div>

      <div class="btnline" style="margin-top:10px">
        <span>ã‚ºãƒ¼ãƒ </span>
        <input id="zoom" class="slider" type="range" min="60" max="200" value="100" style="flex:1">
        <span id="zoomView">100%</span>
        <button id="refresh" class="ghost">æ›´æ–°</button>
      </div>
      <div class="note">ç”ŸæˆPNGã¯ã‚¬ã‚¤ãƒ‰ã‚„æ ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã¯æç”»ã—ã¾ã›ã‚“ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã®ã¿ï¼‰ã€‚</div>
    </section>

    <section class="panel">
      <div class="title">ã‚®ãƒ•ãƒˆä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ï¼‰</div>
      <div class="list" id="list"></div>
      <div class="btnline" style="margin-top:8px">
        <button id="clear" class="ghost">ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="sep"></div>
      <div class="title">é…ç½®ä¸­ï¼ˆæœ€å¤§ ä»»æ„ã®è¡ŒÃ—åˆ—ï¼‰</div>
      <div id="slots" class="slots"></div>
    </section>
  </main>

<script>
(function(){
  "use strict";

  // ===== å›ºå®šã®ã‚·ãƒ¼ãƒˆID / gid =====
  const SHEET_ID = "15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U";
  const GID = "1487601753";
  document.getElementById("sid").textContent = SHEET_ID;
  document.getElementById("sgid").textContent = GID;

  // ===== UIè¦ç´  =====
  const elProxy = document.getElementById("proxy");
  const elList  = document.getElementById("list");
  const elSlots = document.getElementById("slots");
  const elPrev  = document.getElementById("preview");

  const elCols = document.getElementById("cols");
  const elRows = document.getElementById("rows");
  const elTileW= document.getElementById("tileW");
  const elTileH= document.getElementById("tileH");
  const elGap  = document.getElementById("gap");
  const elRadius = document.getElementById("radius");
  const elOffX = document.getElementById("offX");
  const elOffY = document.getElementById("offY");
  const elIconScale = document.getElementById("iconScale");
  const elIconScaleView = document.getElementById("iconScaleView");
  const elIconPad = document.getElementById("iconPad");
  const elOverflow = document.getElementById("overflowOK");
  const elGuide = document.getElementById("guideOn");

  const elLabelText = document.getElementById("labelText");
  const elLabelSize = document.getElementById("labelSize");
  const elLabelColor = document.getElementById("labelColor");
  const elLabelStroke = document.getElementById("labelStroke");
  const elLabelStrokeColor = document.getElementById("labelStrokeColor");
  const elLabelH = document.getElementById("labelH");
  const elLabelV = document.getElementById("labelV");
  const elLabelDx = document.getElementById("labelDx");
  const elLabelDy = document.getElementById("labelDy");

  const elZoom = document.getElementById("zoom");
  const elZoomView = document.getElementById("zoomView");

  const elBgFile = document.getElementById("bgFile");
  const elPickBg = document.getElementById("pickBg");

  // ===== çŠ¶æ…‹ =====
  let allGifts = [];
  let picked = [];
  let bgBitmap = null;
  let lastBgName = "";

  // ===== CSV/GViz util =====
  function parseGViz(text){
    const start = text.indexOf("{");
    const end = text.lastIndexOf("}");
    if(start === -1 || end === -1) throw new Error("GViz parse error");
    return JSON.parse(text.slice(start, end+1));
  }
  function getCellUrl(cell){
    // gviz cell can be: null | {v:any, f:string, p:{link:string}} | {v:"http..."}
    if(!cell) return "";
    if(typeof cell.v === "string" && /^https?:/i.test(cell.v)) return cell.v.trim();
    if(cell.p && typeof cell.p.link === "string") return cell.p.link.trim();
    if(cell.f && typeof cell.f === "string"){
      const m = cell.f.match(/href="([^"]+)"/i);
      if(m) return m[1].trim();
    }
    return "";
  }
  async function fetchTextWithFallback(url, userProxyPrefix){
    const candidates = [];
    if(userProxyPrefix && userProxyPrefix.trim().length>0){
      candidates.push(userProxyPrefix.trim() + encodeURIComponent(url));
    }
    candidates.push(url); // direct
    // final fallback: allorigins (even if not provided)
    if(!userProxyPrefix) candidates.push("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
    for(const u of candidates){
      try{
        const res = await fetch(u, {cache:"no-store"});
        if(!res.ok) continue;
        const tx = await res.text();
        if(tx && tx.length>20) return tx;
      }catch(e){}
    }
    throw new Error("fetch failed");
  }
  async function loadSheet(){
    const url = "https://docs.google.com/spreadsheets/d/"+SHEET_ID+"/gviz/tq?tqx=out:json&gid="+GID;
    const txt = await fetchTextWithFallback(url, elProxy.value);
    const json = parseGViz(txt);
    // build header map
    const cols = json.table.cols.map(c => (c && c.label) ? c.label.trim() : "");
    const idx = {};
    cols.forEach((h,i)=>{ idx[h]=i; });
    const rows = json.table.rows || [];
    const gifts = [];
    for(const r of rows){
      if(!r || !r.c) continue;
      const c = r.c;
      const id   = (c[idx["Gift ID"]] && c[idx["Gift ID"]].v) ? String(c[idx["Gift ID"]].v).trim() : "";
      const name = (c[idx["Gift Name"]] && c[idx["Gift Name"]].v) ? String(c[idx["Gift Name"]].v).trim() : "";
      const cost = (c[idx["Gift Cost"]] && c[idx["Gift Cost"]].v) ? Number(c[idx["Gift Cost"]].v) : 0;
      const img  = getCellUrl(c[idx["Gift Image URL"]]);
      if(id && name && img) gifts.push({id, name, cost, imageUrl: img});
    }
    return gifts;
  }

  // ===== ç”»åƒå–å¾—ï¼ˆBlob -> ObjectURL or ImageBitmapï¼‰ =====
  async function fetchImageBlob(urlRaw){
    const user = (elProxy.value || "").trim();
    const cand = [];
    if(user) cand.push(user + encodeURIComponent(urlRaw));
    try{
      const u = new URL(urlRaw);
      cand.push("https://images.weserv.nl/?url=" + u.host + u.pathname + u.search);
    }catch(e){}
    cand.push(urlRaw);
    for(const u of cand){
      try{
        const r = await fetch(u, {cache:"no-store"});
        if(!r.ok) continue;
        const b = await r.blob();
        if((b.type||"").startsWith("image/")) return b;
      }catch(e){}
    }
    throw new Error("image fetch failed");
  }
  function setImgFromBlob(imgEl, blob){
    const url = URL.createObjectURL(blob);
    imgEl.onload = () => URL.revokeObjectURL(url);
    imgEl.src = url;
  }

  // ===== UIæç”» =====
  function renderList(){
    elList.innerHTML = "";
    for(const g of allGifts){
      const b = document.createElement("div");
      b.className = "gift";
      b.innerHTML = '<div>'+escapeHtml(g.name)+'</div><div class="muted">ğŸª™ '+g.cost+'</div>';
      b.onclick = ()=>{
        picked.push({id:g.id, name:g.name, cost:g.cost, imageUrl:g.imageUrl});
        renderSlots();
        draw();
      };
      elList.appendChild(b);
    }
  }
  function renderSlots(){
    elSlots.innerHTML = "";
    picked.forEach((g,i)=>{
      const row = document.createElement("div");
      row.className = "slotrow";
      const img = document.createElement("img");
      // thumbnail load (no crash on failure)
      fetchImageBlob(g.imageUrl).then(b=>setImgFromBlob(img,b)).catch(()=>{});
      const name = document.createElement("div");
      name.textContent = g.name + " / ğŸª™" + g.cost;
      name.style.flex = "1";
      const a = document.createElement("div");
      a.className = "danger";
      a.textContent = "å‰Šé™¤";
      a.onclick = ()=>{ picked.splice(i,1); renderSlots(); draw(); };
      row.appendChild(img); row.appendChild(name); row.appendChild(a);
      elSlots.appendChild(row);
    });
  }

  // ===== èƒŒæ™¯ã®èª­ã¿è¾¼ã¿ =====
  elPickBg.addEventListener("click", ()=> elBgFile.click());
  elBgFile.addEventListener("change", async (e)=>{
    if(!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    lastBgName = file.name;
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.src = url;
    try{
      await img.decode();
      if("createImageBitmap" in window){
        bgBitmap = await createImageBitmap(img);
      }else{
        // fallback: draw to canvas then create bitmap-like object
        const cv = document.createElement("canvas");
        cv.width = img.naturalWidth; cv.height = img.naturalHeight;
        const cx = cv.getContext("2d");
        cx.drawImage(img,0,0);
        bgBitmap = img;
      }
      URL.revokeObjectURL(url);
      draw();
    }catch(e){
      alert("èƒŒæ™¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  // ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”» =====
  function rrect(ctx,x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  }

  function getLayout(){
    const cols = Math.max(1, parseInt(elCols.value||"6",10));
    const rows = Math.max(1, parseInt(elRows.value||"3",10));
    const w = parseInt(elTileW.value||"320",10);
    const h = parseInt(elTileH.value||"180",10);
    const gap = parseInt(elGap.value||"20",10);
    const rad = parseInt(elRadius.value||"18",10);
    const offx = parseInt(elOffX.value||"0",10);
    const offy = parseInt(elOffY.value||"0",10);
    const s = parseInt(elIconScale.value||"100",10)/100;
    const pad = parseInt(elIconPad.value||"14",10);
    const overflow = elOverflow.value === "1";
    const guide = elGuide.value === "1";

    const gridW = cols*w + (cols+1)*gap;
    const gridH = rows*h + (rows+1)*gap;

    return {cols,rows,w,h,gap,rad,offx,offy,s,pad,overflow,guide,gridW,gridH};
  }

  function draw(){
    const ctx = elPrev.getContext("2d");
    // decide preview canvas size by zoom
    const zoom = parseInt(elZoom.value||"100",10)/100;
    const baseW = bgBitmap ? bgBitmap.width : 1280;
    const baseH = bgBitmap ? bgBitmap.height: 720;
    elPrev.width = Math.round(baseW * zoom);
    elPrev.height= Math.round(baseH * zoom);
    ctx.save();
    ctx.scale(zoom, zoom);

    // background
    if(bgBitmap){
      ctx.drawImage(bgBitmap, 0, 0);
    }else{
      ctx.fillStyle = "#0a1016";
      ctx.fillRect(0,0,baseW,baseH);
    }

    const L = getLayout();
    const gx = Math.round((baseW - L.gridW)/2) + L.offx;
    const gy = Math.round((baseH - L.gridH)/2) + L.offy;

    // guides
    if(L.guide){
      ctx.strokeStyle = "rgba(255,255,255,0.15)";
      ctx.lineWidth = 2;
      for(let r=0;r<L.rows;r++){
        for(let c=0;c<L.cols;c++){
          const x = gx + L.gap + c*(L.w+L.gap);
          const y = gy + L.gap + r*(L.h+L.gap);
          rrect(ctx,x,y,L.w,L.h,L.rad);
          ctx.stroke();
        }
      }
    }

    // icons (draw only what is placed)
    for(let i=0;i<Math.min(picked.length, L.rows*L.cols); i++){
      const g = picked[i];
      const r = Math.floor(i / L.cols);
      const c = i % L.cols;
      const x = gx + L.gap + c*(L.w+L.gap);
      const y = gy + L.gap + r*(L.h+L.gap);

      // draw placeholder box
      // actual image
      // For preview: load as ImageBitmap per draw cycle is heavy; instead cache object URL on row item image if needed.
      // Here we just draw via HTMLImageElement created once per slot.
    }

    // text overlay (preview only)
    const label = elLabelText.value||"";
    if(label){
      ctx.font = "900 "+parseInt(elLabelSize.value||"86",10)+"px system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans JP', sans-serif";
      ctx.textAlign = (elLabelH.value==="left" ? "left" : elLabelH.value==="right" ? "right" : "center");
      ctx.textBaseline = (elLabelV.value==="top" ? "top" : elLabelV.value==="bottom" ? "bottom" : "middle");
      let tx = baseW/2, ty = baseH/2;
      if(elLabelH.value==="left") tx = 30;
      if(elLabelH.value==="right") tx = baseW-30;
      if(elLabelV.value==="top") ty = 40;
      if(elLabelV.value==="bottom") ty = baseH-40;
      tx += parseInt(elLabelDx.value||"0",10);
      ty += parseInt(elLabelDy.value||"0",10);
      if(elLabelStroke.checked){
        ctx.lineWidth = Math.max(4, Math.round(parseInt(elLabelSize.value||"86",10)/12));
        ctx.strokeStyle = elLabelStrokeColor.value||"#000000";
        ctx.strokeText(label, tx, ty);
      }
      ctx.fillStyle = elLabelColor.value||"#ffffff";
      ctx.fillText(label, tx, ty);
    }

    ctx.restore();

    // After backgrounds/guides/text, draw thumbnails of icons into preview using DOM composition:
    // We'll overlay absolutely-positioned <img> over the canvas is complex.
    // Simpler: pre-render bitmaps cache and draw. Implement a lightweight cache:
    drawIconsOnPreview();
  }

  const imageCache = new Map();
  async function getBitmap(url){
    if(imageCache.has(url)) return imageCache.get(url);
    try{
      const blob = await fetchImageBlob(url);
      const bmp = await createImageBitmap(blob);
      imageCache.set(url, bmp);
      return bmp;
    }catch(e){
      imageCache.set(url, null);
      return null;
    }
  }

  async function drawIconsOnPreview(){
    const ctx = elPrev.getContext("2d");
    const zoom = parseInt(elZoom.value||"100",10)/100;
    ctx.save();
    ctx.scale(zoom, zoom);
    const baseW = elPrev.width/zoom;
    const baseH = elPrev.height/zoom;
    const L = getLayout();
    const gx = Math.round((baseW - L.gridW)/2) + L.offx;
    const gy = Math.round((baseH - L.gridH)/2) + L.offy;

    for(let i=0;i<Math.min(picked.length, L.rows*L.cols); i++){
      const g = picked[i];
      const r = Math.floor(i / L.cols);
      const c = i % L.cols;
      const x = gx + L.gap + c*(L.w+L.gap);
      const y = gy + L.gap + r*(L.h+L.gap);
      const bmp = await getBitmap(g.imageUrl);
      if(!bmp) continue;
      const maxW = Math.max(10, L.w - L.pad*2);
      const maxH = Math.max(10, L.h - L.pad*2);
      const scale = L.s * Math.min(maxW/bmp.width, maxH/bmp.height);
      const iw = bmp.width * scale;
      const ih = bmp.height * scale;
      let ix = x + (L.w - iw)/2;
      let iy = y + (L.h - ih)/2;
      if(!L.overflow){
        // clamp inside tile
        ix = Math.max(ix, x); iy = Math.max(iy, y);
      }
      ctx.drawImage(bmp, ix, iy, iw, ih);
    }
    ctx.restore();
  }

  // ===== PNGç”Ÿæˆï¼ˆç”»åƒã®ã¿ï¼‰ =====
  async function exportPNG(){
    if(!bgBitmap){ alert("èƒŒæ™¯ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    const cv = document.createElement("canvas");
    cv.width = bgBitmap.width;
    cv.height= bgBitmap.height;
    const ctx = cv.getContext("2d");
    ctx.drawImage(bgBitmap,0,0);

    const L = getLayout();
    const gx = Math.round((cv.width - L.gridW)/2) + L.offx;
    const gy = Math.round((cv.height - L.gridH)/2) + L.offy;

    for(let i=0;i<Math.min(picked.length, L.rows*L.cols); i++){
      const g = picked[i];
      const r = Math.floor(i / L.cols);
      const c = i % L.cols;
      const x = gx + L.gap + c*(L.w+L.gap);
      const y = gy + L.gap + r*(L.h+L.gap);
      try{
        const bmp = await getBitmap(g.imageUrl);
        if(!bmp) continue;
        const maxW = Math.max(10, L.w - L.pad*2);
        const maxH = Math.max(10, L.h - L.pad*2);
        const scale = L.s * Math.min(maxW/bmp.width, maxH/bmp.height);
        const iw = bmp.width * scale;
        const ih = bmp.height * scale;
        let ix = x + (L.w - iw)/2;
        let iy = y + (L.h - ih)/2;
        if(!L.overflow){
          ix = Math.max(ix, x); iy = Math.max(iy, y);
        }
        ctx.drawImage(bmp, ix, iy, iw, ih);
      }catch(e){}
    }

    try{
      const url = cv.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = url;
      a.download = "gift_board.png";
      a.click();
    }catch(e){
      alert("å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  function bindRedraw(el){ el.addEventListener("input", draw); el.addEventListener("change", draw); }
  [elCols,elRows,elTileW,elTileH,elGap,elRadius,elOffX,elOffY,elIconScale,elIconPad,elOverflow,elGuide,
   elLabelText,elLabelSize,elLabelColor,elLabelStroke,elLabelStrokeColor,elLabelH,elLabelV,elLabelDx,elLabelDy
  ].forEach(bindRedraw);
  elIconScale.addEventListener("input", ()=>{ elIconScaleView.textContent = elIconScale.value; });
  elZoom.addEventListener("input", ()=>{ elZoomView.textContent = elZoom.value+"%"; draw(); });
  document.getElementById("refresh").onclick = draw;
  document.getElementById("clear").onclick = ()=>{ picked=[]; renderSlots(); draw(); };
  document.getElementById("loadBtn").onclick = async ()=>{
    try{
      picked = [];
      renderSlots();
      allGifts = await loadSheet();
      renderList();
      draw();
    }catch(e){
      console.error(e);
      alert("ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã¨URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };
  document.getElementById("saveBtn").onclick = exportPNG;

  // åˆæœŸæç”»
  draw();

})();</script>

</body>
</html>
