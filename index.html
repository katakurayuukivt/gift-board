<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gift Board – Static Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=BIZ+UDPGothic:wght@700&family=M+PLUS+1p:wght@800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1118; --card:#111827; --card2:#0f1624; --muted:#9aa7b8; --accent:#60a5fa; --line:#243445;
      --ink:#e5e7eb; --ink2:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif}
    button,input,select{font:inherit}
    header{display:flex;gap:10px;flex-wrap:wrap;align-items:end;padding:14px;border-bottom:1px solid #0f1a28;background:#0d1522;position:sticky;top:0;z-index:20}
    header .group{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="number"], select{background:#0c1320;border:1px solid #213042;color:#fff;border-radius:9px;padding:8px 10px;min-width:220px}
    input[type="number"]{min-width:110px}
    header .btn{background:var(--accent);color:#071422;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    main{display:grid;grid-template-columns: minmax(420px, 1fr) 420px; gap:16px;padding:16px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .title{font-weight:900;margin:4px 0 10px 0}
    .grid2{display:grid;grid-template-columns: repeat(2, 1fr); gap:8px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:6px;align-items:center}
    .muted{color:var(--muted)}
    .btn{background:#213248;color:#e5e7eb;border:none;border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn.small{padding:6px 8px;font-size:12px}
    .list{display:grid;grid-template-columns: 1fr 1fr; gap:8px; height:520px; overflow:auto}
    .gift{background:var(--card2);border:1px solid #243246;border-radius:12px;padding:10px}
    .gift .nm{font-weight:800}
    .slots{display:grid;grid-template-columns: 1fr; gap:10px;max-height:720px; overflow:auto}
    .slot{background:#0f1626;border:1px solid #223049;border-radius:12px;padding:10px}
    .slot .cap{font-size:12px;color:var(--muted);margin-bottom:6px}
    .slot .name{font-weight:800}
    .slot .edit{margin-top:8px}
    .slot .edit details{margin-top:6px}
    .slot .edit summary{user-select:none}
    .slot .edit .grid{display:grid;grid-template-columns:80px 1fr;gap:6px;align-items:center}
    .slot .row2{display:grid;grid-template-columns:80px 1fr;gap:6px;align-items:center;margin:6px 0}
    .danger{color:#f87171;cursor:pointer}
    canvas{background:#050b12;border:1px solid #1a2a3c;border-radius:10px;width:100%}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .hr{height:1px;background:#192535;margin:10px 0}
    .zoom{display:flex;align-items:center;gap:8px}
    .zoom input{width:260px}
    .right-fixed{position:sticky; top:70px; height: calc(100vh - 86px); overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0d1a2b;border:1px solid #25364b;border-radius:999px;padding:4px 8px;font-size:12px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#111933;border:1px solid #24324a;border-radius:6px;padding:0 6px}
    .note{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="group">
      <label>Sheet ID（固定）</label>
      <input id="sheetId" type="text">
    </div>
    <div class="group">
      <label>gid（固定）</label>
      <input id="gid" type="text">
    </div>
    <div class="group" style="min-width:340px">
      <label>CORSプロキシ（任意・画像/CSV対策）</label>
      <input id="proxy" type="text" placeholder="例: https://api.allorigins.win/raw?url=">
    </div>
    <div class="group">
      <button id="loadBtn" class="btn">読み込む</button>
    </div>
    <div class="group" style="margin-left:auto">
      <button id="pickBgBtn" class="btn">背景画像を選ぶ</button>
    </div>
    <div class="group">
      <button id="saveBtn" class="btn">PNGとして保存</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="title">ライブプレビュー</div>

      <div class="grid2">
        <div class="row"><label>列 (COLS)</label><input id="cols" type="number" value="6" min="1" max="12"></div>
        <div class="row"><label>行 (ROWS)</label><input id="rows" type="number" value="3" min="1" max="10"></div>
        <div class="row"><label>枠高 TILE_H</label><input id="tileH" type="number" value="180" min="60" max="800"></div>
        <div class="row"><label>枠幅 TILE_W</label><input id="tileW" type="number" value="320" min="60" max="1000"></div>
        <div class="row"><label>枠間 G A P</label><input id="gap" type="number" value="20" min="0" max="120"></div>
        <div class="row"><label>丸角 px</label><input id="radius" type="number" value="18" min="0" max="80"></div>
        <div class="row"><label>左上オフセット X</label><input id="offX" type="number" value="0"></div>
        <div class="row"><label>左上オフセット Y</label><input id="offY" type="number" value="0"></div>
        <div class="row"><label>アイコン余白 px</label><input id="iconPad" type="number" value="14" min="0" max="120"></div>
        <div class="row"><label>はみ出しOK（タイル外へ）</label>
          <select id="spill"><option value="0">OFF</option><option value="1">ON</option></select>
        </div>
        <div class="row"><label>ガイド枠描画</label>
          <select id="guide"><option value="1">ON</option><option value="0">OFF</option></select>
        </div>
      </div>

      <div class="hr"></div>
      <canvas id="preview" width="1280" height="720"></canvas>
      <div class="toolbar">
        <div class="zoom">
          <span class="muted">ズーム</span>
          <input id="zoom" type="range" min="30" max="300" value="100">
          <span id="zoomVal" class="pill">100%</span>
        </div>
        <button id="refresh" class="btn small">更新</button>
        <span class="note">※ 出力PNGはガイド枠やテキスト枠は描画しません（アイコン画像＋追加画像＋テキストのみ）。</span>
      </div>
    </section>

    <section class="panel right-fixed">
      <div class="title">ギフト一覧（クリックで追加）</div>
      <div id="list" class="list"></div>
      <div class="toolbar">
        <button id="clearBtn" class="btn">クリア</button>
        <span class="muted">必要カラム: <b>Gift ID / Gift Name / Gift Cost / Gift Image URL</b></span>
      </div>

      <div class="hr"></div>
      <div class="title">配置中（最大 任意の行×列）</div>
      <div id="slots" class="slots"></div>
    </section>
  </main>

  <input id="bgFile" type="file" accept="image/*" style="display:none">

<script>
(() => {
  'use strict';

  // ===== Defaults (固定) =====
  const DEFAULT_SHEET_ID = '15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U';
  const DEFAULT_GID      = '1487601753';

  // ===== State =====
  let all = [];     // 全ギフト
  let picked = [];  // 選択済み
  const fonts = ['Noto Sans JP','BIZ UDPGothic','M PLUS 1p','system-ui'];

  // ===== DOM =====
  const elSheetId = document.getElementById('sheetId');
  const elGid     = document.getElementById('gid');
  const elProxy   = document.getElementById('proxy');
  elSheetId.value = DEFAULT_SHEET_ID;
  elGid.value     = DEFAULT_GID;
  elProxy.value   = 'https://api.allorigins.win/raw?url=';

  const list    = document.getElementById('list');
  const slots   = document.getElementById('slots');
  const canvas  = document.getElementById('preview');
  const ctx     = canvas.getContext('2d');
  const bgFile  = document.getElementById('bgFile');

  // Layout controls
  const cols   = document.getElementById('cols');
  const rows   = document.getElementById('rows');
  const tileW  = document.getElementById('tileW');
  const tileH  = document.getElementById('tileH');
  const gap    = document.getElementById('gap');
  const radius = document.getElementById('radius');
  const offX   = document.getElementById('offX');
  const offY   = document.getElementById('offY');
  const guide  = document.getElementById('guide');
  const iconPad= document.getElementById('iconPad');
  const spill  = document.getElementById('spill');
  const zoom   = document.getElementById('zoom');
  const zoomVal= document.getElementById('zoomVal');

  // Background image
  const bg = { img:null, w:1280, h:720 };

  // ===== Utils =====
  function csvToRows(csv){
    const out = []; let cell='', row=[], i=0, inQ=false;
    while(i<csv.length){
      const ch = csv[i];
      if(inQ){
        if(ch === '"'){
          if(csv[i+1] === '"'){ cell+='"'; i+=2; }
          else { inQ=false; i++; }
        }else{ cell+=ch; i++; }
      }else{
        if(ch === '"'){ inQ=true; i++; }
        else if(ch === ','){ row.push(cell); cell=''; i++; }
        else if(ch === '\n'){ row.push(cell); out.push(row); cell=''; row=[]; i++; }
        else if(ch === '\r'){ i++; }
        else { cell+=ch; i++; }
      }
    }
    row.push(cell); out.push(row);
    return out;
  }

  async function fetchTextWithFallback(rawUrl){
    const cand = [];
    const user = (elProxy.value||'').trim();
    if(user) cand.push(user + encodeURIComponent(rawUrl));
    cand.push(rawUrl);
    cand.push('https://cors.isomorphic-git.org/' + rawUrl);
    for(const u of cand){
      try{
        const r = await fetch(u, {cache:'no-store'});
        if(!r.ok) continue;
        const t = await r.text();
        if(t) return t;
      }catch(e){}
    }
    throw new Error('fetchText failed');
  }

  async function fetchImageBlobWithFallback(rawUrl){
    const cand = [];
    const user = (elProxy.value||'').trim();
    if(user) cand.push(user + encodeURIComponent(rawUrl));
    try{
      const u = new URL(rawUrl);
      cand.push(`https://images.weserv.nl/?url=${u.host}${u.pathname}${u.search}`);
    }catch{}
    cand.push('https://cors.isomorphic-git.org/' + rawUrl);
    cand.push(rawUrl);

    for(const u of cand){
      try{
        const r = await fetch(u, {cache:'no-store'});
        if(!r.ok) continue;
        const b = await r.blob();
        if((b.type||'').startsWith('image/')) return b;
      }catch(e){}
    }
    throw new Error('img fetch failed');
  }

  // ===== Load sheet =====
  async function loadSheet(sheetId, gid){
    const base = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
    const text = await fetchTextWithFallback(base);
    const rows = csvToRows(text);
    const header = rows[0].map(h=>h.trim());
    const map = Object.fromEntries(header.map((h,i)=>[h,i]));
    const out = rows.slice(1).map(r => ({
      id: r[map['Gift ID']] || '',
      name: r[map['Gift Name']] || '',
      cost: Number(r[map['Gift Cost']] || 0),
      imageUrl: (r[map['Gift Image URL']] || '').trim()
    })).filter(g => g.id && g.name && g.imageUrl);
    return out;
  }

  // ===== UI =====
  function renderList(){
    list.innerHTML = '';
    const frag = document.createDocumentFragment();
    all.forEach(g=>{
      const d = document.createElement('div');
      d.className = 'gift';
      d.innerHTML = `<div class="nm">${escapeHtml(g.name)}</div>
                     <div class="muted">🪙 ${g.cost}</div>`;
      d.onclick = ()=>{
        if(picked.length >= Number(cols.value) * Number(rows.value)) return;
        const slot = {
          ...g,
          effect:'',
          text:{ value:'', size:86, color:'#ffffff', stroke:true, ox:0, oy:0, h:'center', v:'center', font:'Noto Sans JP' },
          giftTfm:{ scale:1, dx:0, dy:0 },
          add1:{ dataUrl:'', scale:1, dx:0, dy:0, _img:null },
          _giftImg:null
        };
        picked.push(slot);
        preloadGift(slot);
        renderSlots();
        requestPreview();
      };
      frag.appendChild(d);
    });
    list.appendChild(frag);
  }

  function renderSlots(){
    slots.innerHTML = '';
    const total = Number(cols.value) * Number(rows.value);
    for(let i=0;i<total;i++){
      const g = picked[i];
      const d = document.createElement('div');
      d.className = 'slot';
      const cap = document.createElement('div');
      cap.className = 'cap';
      cap.textContent = `スロット ${i+1}`;
      d.appendChild(cap);

      if(g){
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = `${g.name} / 🪙${g.cost}`;
        d.appendChild(name);

        // 編集UI
        const edit = document.createElement('div');
        edit.className = 'edit';

        // ギフト画像調整
        edit.innerHTML += `
          <details open>
            <summary>ギフト画像の調整</summary>
            <div class="grid">
              <label>拡大率</label><input data-k="gift-scale" type="range" min="50" max="220" value="${Math.round((g.giftTfm?.scale??1)*100)}">
              <label>位置X</label><input data-k="gift-dx" type="number" value="${g.giftTfm?.dx??0}">
              <label>位置Y</label><input data-k="gift-dy" type="number" value="${g.giftTfm?.dy??0}">
              <div></div><button data-k="gift-center" class="btn small">中央</button>
            </div>
          </details>
        `;

        // 追加画像
        edit.innerHTML += `
          <details>
            <summary>追加画像（重ねる）</summary>
            <div class="grid">
              <label>画像</label><input data-k="add-file" type="file" accept="image/*">
              <label>拡大率</label><input data-k="add-scale" type="range" min="30" max="240" value="${Math.round((g.add1?.scale??1)*100)}">
              <label>位置X</label><input data-k="add-dx" type="number" value="${g.add1?.dx??0}">
              <label>位置Y</label><input data-k="add-dy" type="number" value="${g.add1?.dy??0}">
              <div></div><button data-k="add-center" class="btn small">中央</button>
            </div>
          </details>
        `;

        // テキスト
        edit.innerHTML += `
          <details>
            <summary>テキスト</summary>
            <div class="grid">
              <label>内容</label><input data-k="t-value" type="text" value="${escapeAttr(g.text?.value||'')}">
              <label>サイズ</label><input data-k="t-size" type="number" value="${g.text?.size||86}">
              <label>色</label><input data-k="t-color" type="color" value="${g.text?.color||'#ffffff'}">
              <label>縁取り</label><input data-k="t-stroke" type="checkbox" ${g.text?.stroke!==false?'checked':''}>
              <label>フォント</label>
              <select data-k="t-font">
                ${fonts.map(f=>`<option ${g.text?.font===f?'selected':''}>${f}</option>`).join('')}
              </select>
              <label>水平</label>
              <select data-k="t-h">
                <option value="left" ${g.text?.h==='left'?'selected':''}>左</option>
                <option value="center" ${(!g.text || g.text.h==='center')?'selected':''}>中央</option>
                <option value="right" ${g.text?.h==='right'?'selected':''}>右</option>
              </select>
              <label>垂直</label>
              <select data-k="t-v">
                <option value="top" ${g.text?.v==='top'?'selected':''}>上</option>
                <option value="middle" ${(!g.text || g.text.v==='middle' || g.text.v==='center')?'selected':''}>中央</option>
                <option value="bottom" ${g.text?.v==='bottom'?'selected':''}>下</option>
              </select>
              <label>オフセットX</label><input data-k="t-ox" type="number" value="${g.text?.ox||0}">
              <label>オフセットY</label><input data-k="t-oy" type="number" value="${g.text?.oy||0}">
            </div>
          </details>
        `;

        const small = document.createElement('div');
        small.className = 'flex';
        small.style.marginTop = '8px';
        small.innerHTML = `<span class="pill">${g.id}</span><span class="danger">削除</span>`;
        small.querySelector('.danger').onclick = ()=>{ picked.splice(i,1); renderSlots(); requestPreview(); };
        d.appendChild(edit);
        d.appendChild(small);

        // ハンドラ
        edit.querySelectorAll('input,select,button').forEach(el=>{
          el.oninput = el.onclick = (ev)=>{
            const k = el.dataset.k;
            picked[i].giftTfm ||= { scale:1, dx:0, dy:0 };
            picked[i].add1    ||= { dataUrl:'', scale:1, dx:0, dy:0, _img:null };
            picked[i].text    ||= { value:'', size:86, color:'#ffffff', stroke:true, ox:0, oy:0, h:'center', v:'center', font:'Noto Sans JP' };
            if(k==='gift-scale') picked[i].giftTfm.scale = Number(el.value)/100;
            if(k==='gift-dx') picked[i].giftTfm.dx = Number(el.value);
            if(k==='gift-dy') picked[i].giftTfm.dy = Number(el.value);
            if(k==='gift-center'){ picked[i].giftTfm.dx=0; picked[i].giftTfm.dy=0; }

            if(k==='add-file'){
              const f = el.files && el.files[0];
              if(f){
                const fr = new FileReader();
                fr.onload = ()=>{
                  picked[i].add1.dataUrl = fr.result;
                  const img = new Image();
                  img.onload = ()=>{ picked[i].add1._img = img; requestPreview(); };
                  img.src = fr.result;
                };
                fr.readAsDataURL(f);
              }
            }
            if(k==='add-scale') picked[i].add1.scale = Number(el.value)/100;
            if(k==='add-dx') picked[i].add1.dx = Number(el.value);
            if(k==='add-dy') picked[i].add1.dy = Number(el.value);
            if(k==='add-center'){ picked[i].add1.dx=0; picked[i].add1.dy=0; }

            if(k==='t-value') picked[i].text.value = el.value;
            if(k==='t-size') picked[i].text.size = Number(el.value);
            if(k==='t-color') picked[i].text.color = el.value;
            if(k==='t-stroke') picked[i].text.stroke = el.checked;
            if(k==='t-ox') picked[i].text.ox = Number(el.value);
            if(k==='t-oy') picked[i].text.oy = Number(el.value);
            if(k==='t-h') picked[i].text.h = el.value;
            if(k==='t-v') picked[i].text.v = (el.value==='middle'?'middle':el.value);
            if(k==='t-font') picked[i].text.font = el.value;

            requestPreview();
          };
        });
      }else{
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = '（未配置）';
        d.appendChild(empty);
      }

      slots.appendChild(d);
    }
  }

  // ===== Drawing =====
  function gridSize(){
    const C = Number(cols.value), R = Number(rows.value);
    const W = Number(tileW.value), H = Number(tileH.value), G = Number(gap.value);
    const gw = C*W + (C+1)*G;
    const gh = R*H + (R+1)*G;
    return {gw, gh, C, R, W, H, G};
  }

  function roundRectPath(ctx, x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  function computeTileRect(i){
    const {C,W,H,G} = gridSize();
    const r = Math.floor(i / C), c = i % C;
    const x = Number(offX.value) + G + c*(W+G);
    const y = Number(offY.value) + G + r*(H+G);
    return {x,y,w:W,h:H};
  }

  function drawGridBack(ctx){
    const {gw,gh} = gridSize();
    const zx = Number(zoom.value)/100;
    canvas.style.height = (gh*zx) + 'px';
    canvas.style.width  = (gw*zx) + 'px';
    canvas.width  = Math.max(1, Math.floor(gw*zx));
    canvas.height = Math.max(1, Math.floor(gh*zx));

    // draw background
    ctx.save();
    ctx.fillStyle = '#0b131d';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.restore();

    // Draw bg image scaled to canvas size (preview)
    if(bg.img){
      // Fit bg to canvas
      const s = Math.min(canvas.width / bg.w, canvas.height / bg.h);
      const w = bg.w * s, h = bg.h * s;
      ctx.drawImage(bg.img, (canvas.width - w)/2, (canvas.height - h)/2, w, h);
    }
  }

  function drawGuide(ctx){
    const {C,R,W,H,G} = gridSize();
    const zx = Number(zoom.value)/100;
    const r = Number(radius.value);
    // guides
    ctx.save();
    ctx.lineWidth = Math.max(1, 1*zx);
    for(let rr=0; rr<R; rr++){
      for(let cc=0; cc<C; cc++){
        const x = (Number(offX.value) + G + cc*(W+G)) * zx;
        const y = (Number(offY.value) + G + rr*(H+G)) * zx;
        roundRectPath(ctx, x,y, W*zx, H*zx, r*zx);
        ctx.strokeStyle = 'rgba(180,200,220,0.16)';
        ctx.stroke();
      }
    }
    ctx.restore();
  }

  function drawSlotContent(ctx, tileRect, slot, scaleForCanvas){
    // scaleForCanvas = preview zoom (e.g., 1.25)
    const pad = Number(iconPad.value);
    const boxW = tileRect.w - pad*2;
    const boxH = tileRect.h - pad*2;
    const cx = tileRect.x + tileRect.w/2;
    const cy = tileRect.y + tileRect.h/2;

    // 1) Gift image (bottom)
    const giftImg = slot._giftImg;
    if(giftImg){
      const fit = Math.min(boxW / giftImg.width, boxH / giftImg.height);
      const tfm = slot.giftTfm || {scale:1,dx:0,dy:0};
      const s = fit * tfm.scale;
      const iw = giftImg.width * s;
      const ih = giftImg.height * s;
      const gx = cx + (tfm.dx||0);
      const gy = cy + (tfm.dy||0);

      ctx.drawImage(giftImg, (gx - iw/2)*scaleForCanvas, (gy - ih/2)*scaleForCanvas, iw*scaleForCanvas, ih*scaleForCanvas);
    }

    // 2) Add-on image (mid)
    const add = slot.add1;
    if(add && (add._img || add.dataUrl)){
      const img = add._img;
      if(img && img.complete){
        const fit = Math.min(boxW / img.naturalWidth, boxH / img.naturalHeight);
        const s = fit * (add.scale||1);
        const iw = img.naturalWidth * s;
        const ih = img.naturalHeight * s;
        const ax = cx + (add.dx||0);
        const ay = cy + (add.dy||0);
        ctx.drawImage(img, (ax - iw/2)*scaleForCanvas, (ay - ih/2)*scaleForCanvas, iw*scaleForCanvas, ih*scaleForCanvas);
      }
    }

    // 3) Text (top)
    const t = slot.text || {value:'',size:86,color:'#fff',stroke:true,ox:0,oy:0,h:'center',v:'middle',font:'Noto Sans JP'};
    if(t.value){
      ctx.save();
      const fontSpec = `900 ${t.size*scaleForCanvas}px "${t.font||'Noto Sans JP'}", system-ui, sans-serif`;
      ctx.font = fontSpec;
      ctx.fillStyle = t.color || '#fff';
      ctx.textAlign = (t.h==='left'?'left':t.h==='right'?'right':'center');
      ctx.textBaseline = (t.v==='top'?'top':t.v==='bottom'?'bottom':'middle');
      const tx = (cx + (t.ox||0))*scaleForCanvas;
      const ty = (cy + (t.oy||0))*scaleForCanvas;
      if(t.stroke!==false){
        ctx.lineWidth = Math.max(2, Math.floor(t.size*0.12*scaleForCanvas));
        ctx.strokeStyle = 'rgba(0,0,0,0.75)';
        ctx.strokeText(t.value, tx, ty);
      }
      ctx.fillText(t.value, tx, ty);
      ctx.restore();
    }
  }

  function drawPreview(){
    drawGridBack(ctx);
    const zx = Number(zoom.value)/100;
    const {C,R} = gridSize();

    // tiles
    for(let i=0;i<C*R;i++){
      const tr = computeTileRect(i);
      // convert to preview scale
      const tr2 = {x: tr.x*zx, y: tr.y*zx, w: tr.w*zx, h: tr.h*zx};
      if(Number(guide.value)){
        // draw soft tile bg
        ctx.save();
        roundRectPath(ctx, tr2.x, tr2.y, tr2.w, tr2.h, Number(radius.value)*zx);
        ctx.fillStyle = 'rgba(0,0,0,0.25)';
        ctx.fill();
        ctx.restore();
      }

      const slot = picked[i];
      if(!slot) continue;
      drawSlotContent(ctx, tr, slot, zx);
    }

    if(Number(guide.value)) drawGuide(ctx);
  }

  let rafId = 0;
  function requestPreview(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(()=>{
      rafId = 0;
      drawPreview();
    });
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }

  async function preloadGift(slot){
    try{
      const blob = await fetchImageBlobWithFallback(slot.imageUrl);
      const bmp = await createImageBitmap(blob);
      slot._giftImg = bmp;
      requestPreview();
    }catch(e){
      console.warn('gift image failed', slot.name, e);
    }
  }

  // ===== Export PNG =====
  async function drawToCanvasForExport(exp){
    // exp: {canvas, ctx}
    const {gw, gh} = gridSize();
    const W = bg.img ? bg.w : gw;
    const H = bg.img ? bg.h : gh;
    exp.canvas.width = W;
    exp.canvas.height = H;

    // background
    if(bg.img) exp.ctx.drawImage(bg.img, 0,0,W,H);
    else { exp.ctx.fillStyle = '#0b131d'; exp.ctx.fillRect(0,0,W,H); }

    // compute offset to center grid when bg larger
    const ox = (W - gw) / 2;
    const oy = (H - gh) / 2;

    for(let i=0;i<Number(cols.value)*Number(rows.value); i++){
      const base = computeTileRect(i);
      const tileRect = { x: base.x + ox, y: base.y + oy, w: base.w, h: base.h };
      const slot = picked[i];
      if(!slot) continue;
      drawSlotContent(exp.ctx, tileRect, slot, 1); // scale=1 in export
    }
  }

  async function exportPNG(){
    const c = document.createElement('canvas');
    const x = c.getContext('2d');
    await drawToCanvasForExport({canvas:c, ctx:x});
    try{
      const url = c.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'gift_board.png'; a.click();
    }catch(e){
      alert('出力に失敗しました（ブラウザ制限）。');
    }
  }

  // ===== Events =====
  document.getElementById('loadBtn').onclick = async ()=>{
    try{
      picked = []; renderSlots(); requestPreview();
      all = await loadSheet(elSheetId.value.trim(), elGid.value.trim());
      renderList();
    }catch(e){
      console.error(e);
      alert('シートの読み込みに失敗しました。権限とURLを確認してください。');
    }
  };
  document.getElementById('clearBtn').onclick = ()=>{ picked = []; renderSlots(); requestPreview(); };
  document.getElementById('refresh').onclick = requestPreview;
  document.getElementById('saveBtn').onclick = exportPNG;
  zoom.oninput = ()=>{ zoomVal.textContent = zoom.value+'%'; requestPreview(); };
  [cols,rows,tileW,tileH,gap,radius,offX,offY,guide,iconPad,spill].forEach(el=> el.oninput = ()=>{ renderSlots(); requestPreview(); });

  // 背景画像
  document.getElementById('pickBgBtn').onclick = ()=> bgFile.click();
  bgFile.onchange = ()=>{
    const f = bgFile.files && bgFile.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{
      bg.img = img; bg.w = img.naturalWidth; bg.h = img.naturalHeight;
      URL.revokeObjectURL(url);
      requestPreview();
    };
    img.src = url;
  };

  // 初期描画
  requestPreview();
  renderSlots();
})();
</script>
</body>
</html>
