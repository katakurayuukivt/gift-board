<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gift Board — GitHub Pages版</title>
  <style>
    :root{
      --bg:#0e1218; --card:#151a23; --muted:#9aa7b8; --accent:#60a5fa; --edge:#263244;
      --ink:#e5e7eb; --ink-weak:#cbd5e1;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; }
    button, input, select { font-family: inherit; }
    .wrap{ display:grid; grid-template-columns: 1fr 360px; gap:16px; padding:16px; }
    header{ display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid #202633; }
    header .pill{ background:#0c1119; border:1px solid var(--edge); color:var(--ink); border-radius:10px; padding:8px 12px; font-size:13px; }
    header .pill code{ color:#bcd0e6; }
    header .spacer{ flex:1; }
    header .btn{ background:var(--accent); color:#061020; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .panel{ background:var(--card); border:1px solid var(--edge); border-radius:14px; padding:14px; }
    .title{ font-weight:800; margin-bottom:10px; color:#d8e2f0; }

    .grid2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    .grid3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; }
    .row{ display:flex; gap:8px; align-items:center; }
    label{ color:var(--muted); font-size:12px; }
    input[type="text"], input[type="number"], select{
      width:100%; background:#0b0f15; color:#fff; border:1px solid #2a3446; border-radius:8px; padding:8px 10px;
    }
    input[type="range"]{ width:100%; }
    .btn{ background:#223045; color:#e8eef9; border:1px solid #2a384d; border-radius:10px; padding:8px 10px; cursor:pointer; }
    .btn.primary{ background:var(--accent); color:#05101e; border:none; font-weight:700; }

    /* 左側 */
    .previewWrap{ display:flex; flex-direction:column; gap:12px; }
    #previewHolder{ position:relative; overflow:auto; background:#0a0f16; border:1px dashed #2a3446; border-radius:12px; padding:12px; }
    #preview{ display:block; max-width:none; image-rendering: auto; }
    .zoomRow{ display:flex; gap:10px; align-items:center; }
    .zoomRow span{ font-size:12px; color:var(--muted); }

    /* 右側 */
    .lists{ display:flex; flex-direction:column; gap:16px; }
    .giftList{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; max-height:40vh; overflow:auto; }
    .gift{ background:#0f1623; border:1px solid #2a3446; border-radius:12px; padding:10px; text-align:left; cursor:pointer; }
    .gift .nm{ font-weight:800; }
    .gift .co{ color:#f0d32f; font-size:12px; }
    .slots{ display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:8px; max-height:40vh; overflow:auto; }
    .slot{ background:#0f1623; border:1px solid #2a3446; border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .slot .l{ display:flex; align-items:center; gap:8px; }
    .slot img{ width:36px; height:36px; object-fit:contain; background:#0b0f15; border:1px solid #2a3446; border-radius:8px; }
    .slot .cap{ color:#8fa1b6; font-size:12px; }
    .slot .rm{ color:#f87171; cursor:pointer; }
    .note{ color:var(--muted); font-size:12px; }

    .kbd{ font: 12px/1.3 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#0b0f15; border:1px solid #2a3446; padding:2px 6px; border-radius:6px; }

    @media (max-width: 1000px){
      .wrap{ grid-template-columns: 1fr; }
      .giftList, .slots { max-height:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="pill">Sheet ID: <code id="sheetIdText"></code></div>
    <div class="pill">gid: <code id="gidText"></code></div>
    <div class="pill">CORSプロキシ（任意・PNG出力時のみ推奨）
      <input id="proxy" placeholder="例）https://api.allorigins.win/raw?url=" style="width:340px; margin-left:8px;" />
    </div>
    <button class="btn" id="loadBtn">読み込む</button>
    <div class="spacer"></div>
    <input id="bgFile" type="file" accept="image/*" style="display:none" />
    <button class="btn" id="pickBgBtn">背景画像を選ぶ</button>
    <button class="btn primary" id="saveBtn">PNGとして保存</button>
  </header>

  <div class="wrap">
    <section class="panel previewWrap">
      <div class="title">ライブプレビュー</div>
      <div class="grid3">
        <div>
          <label>列 (COLS)</label>
          <input type="number" id="cols" value="6" min="1" max="12" />
        </div>
        <div>
          <label>行 (ROWS)</label>
          <input type="number" id="rows" value="3" min="1" max="8" />
        </div>
        <div>
          <label>枠幅 TILE_W</label>
          <input type="number" id="tileW" value="320" />
        </div>
        <div>
          <label>枠高 TILE_H</label>
          <input type="number" id="tileH" value="180" />
        </div>
        <div>
          <label>枠間 GAP</label>
          <input type="number" id="gap" value="20" />
        </div>
        <div>
          <label>丸角 px</label>
          <input type="number" id="radius" value="18" />
        </div>
        <div>
          <label>左上オフセット X</label>
          <input type="number" id="offX" value="0" />
        </div>
        <div>
          <label>左上オフセット Y</label>
          <input type="number" id="offY" value="0" />
        </div>
        <div>
          <label>ガイド枠描画</label>
          <select id="guide"><option>ON</option><option>OFF</option></select>
        </div>
      </div>

      <div class="grid3" style="margin-top:8px">
        <div>
          <label>アイコン倍率（% / タイル基準）</label>
          <input type="range" id="iconScale" min="40" max="180" value="100" />
        </div>
        <div>
          <label>アイコン余白（px）</label>
          <input type="number" id="iconPad" value="14" />
        </div>
        <div>
          <label>はみ出しOK（タイル外へ）</label>
          <select id="overflow"><option>OFF</option><option>ON</option></select>
        </div>
      </div>

      <div class="grid3" style="margin-top:8px">
        <div>
          <label>テキスト</label>
          <input type="text" id="labelText" value="テスト" />
        </div>
        <div>
          <label>文字サイズ px</label>
          <input type="number" id="labelSize" value="86" />
        </div>
        <div class="row" style="margin-top:18px">
          <label>色</label>
          <input type="color" id="labelColor" value="#ffffff" style="width:60px">
          <label>縁</label>
          <input type="checkbox" id="labelStroke" checked />
        </div>
        <div>
          <label>横位置</label>
          <select id="labelAlignX">
            <option value="left">左</option>
            <option value="center" selected>中央</option>
            <option value="right">右</option>
          </select>
        </div>
        <div>
          <label>縦位置</label>
          <select id="labelAlignY">
            <option value="top">上</option>
            <option value="middle" selected>中央</option>
            <option value="bottom">下</option>
          </select>
        </div>
        <div class="grid2">
          <div>
            <label>文字オフセット X</label>
            <input type="number" id="labelOffX" value="0" />
          </div>
          <div>
            <label>文字オフセット Y</label>
            <input type="number" id="labelOffY" value="0" />
          </div>
        </div>
      </div>

      <div id="previewHolder">
        <canvas id="preview"></canvas>
      </div>
      <div class="zoomRow">
        <span>ズーム</span>
        <input id="zoom" type="range" min="50" max="200" value="100" />
        <span><span id="zoomVal">100</span>%</span>
        <button class="btn" id="rerender">更新</button>
      </div>
      <div class="note">※ 生成PNGはガイドや枠・テキストは描画しません（アイコン画像のみ）。</div>
    </section>

    <section class="lists">
      <div class="panel">
        <div class="title">ギフト一覧（クリックで追加）</div>
        <div id="giftList" class="giftList"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="clearBtn">クリア</button>
        </div>
        <div class="note">必要カラム：<b>Gift ID / Gift Name / Gift Cost / Gift Image URL</b></div>
      </div>

      <div class="panel">
        <div class="title">配置中（最大 任意の行×列）</div>
        <div id="slots" class="slots"></div>
      </div>
    </section>
  </div>

  <canvas id="export" style="display:none"></canvas>

<script>
(() => {
  // ===== 固定シート設定（変更可） =====
  const SHEET_ID = "15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U";
  const GID = "1487601753";
  document.getElementById('sheetIdText').textContent = SHEET_ID;
  document.getElementById('gidText').textContent = GID;

  // ====== 状態 ======
  const state = {
    all: [],         // 全ギフト
    picked: [],      // 選択済み（スロット順）
    bgImg: null,     // 背景Image
    previewScale: 1, // 表示用ズーム
  };

  // ===== DOM =====
  const el = (id)=>document.getElementById(id);
  const listEl = el('giftList');
  const slotsEl = el('slots');
  const preview = el('preview');
  const ctx = preview.getContext('2d');
  const exportCV = el('export');
  const ectx = exportCV.getContext('2d');

  const inputs = {
    cols: el('cols'),
    rows: el('rows'),
    tileW: el('tileW'),
    tileH: el('tileH'),
    gap: el('gap'),
    radius: el('radius'),
    offX: el('offX'),
    offY: el('offY'),
    guide: el('guide'),
    iconScale: el('iconScale'),
    iconPad: el('iconPad'),
    overflow: el('overflow'),
    labelText: el('labelText'),
    labelSize: el('labelSize'),
    labelColor: el('labelColor'),
    labelStroke: el('labelStroke'),
    labelAlignX: el('labelAlignX'),
    labelAlignY: el('labelAlignY'),
    labelOffX: el('labelOffX'),
    labelOffY: el('labelOffY'),
    zoom: el('zoom'),
    zoomVal: el('zoomVal'),
    proxy: el('proxy'),
  };

  // ===== CSV utils =====
  function csvToRows(text){
    const rows=[]; let i=0, cell='', row=[], inQ=false;
    while(i<text.length){
      const ch = text[i];
      if(inQ){
        if(ch==='"'){ if(text[i+1]==='"'){ cell+='"'; i+=2; } else { inQ=false; i++; } }
        else { cell+=ch; i++; }
      } else {
        if(ch==='"'){ inQ=true; i++; }
        else if(ch===','){ row.push(cell); cell=''; i++; }
        else if(ch==='
'){ row.push(cell); rows.push(row); cell=''; row=[]; i++; }
        else if(ch===''){ i++; }
        else { cell+=ch; i++; }
      }
    }
    if(cell!=='' || row.length) { row.push(cell); rows.push(row); }
    return rows;
  }

  async function loadSheet(){
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
    const userProxy = (inputs.proxy.value||'').trim();
    const candidates = [];
    if(userProxy) candidates.push(userProxy + encodeURIComponent(base));
    candidates.push(`https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`);
    candidates.push(base);

    for(const u of candidates){
      try{
        const res = await fetch(u, { cache:'no-store' });
        if(!res.ok) continue;
        const txt = await res.text();
        const rows = csvToRows(txt);
        const header = rows[0].map(h=>h.trim());
        const map = Object.fromEntries(header.map((h,i)=>[h,i]));
        const data = rows.slice(1).map(r => ({
          id: r[map['Gift ID']] || '',
          name: r[map['Gift Name']] || '',
          cost: Number(r[map['Gift Cost']] || 0),
          imageUrl: extractUrl(r[map['Gift Image URL']] || '')
        })).filter(g => g.id && g.name && g.imageUrl);
        if(data.length){
          state.all = data;
          return true;
        }
      }catch(e){ /* try next */ }
    }
    throw new Error('シート取得に失敗（CORS/権限/URL）');
  }

  // = HYPERLINK("URL","表示") を素直に取り出す（CSVが表示テキストでもURLが紛れていた時用）
  function extractUrl(s){
    const t = (s||'').trim();
    if(/^https?:\/\//i.test(t)) return t;
    const m = t.match(/https?:\/\/[^\s")]+/i);
    return m ? m[0] : t;
  }

  // ===== 画像取得（プロキシ→直） =====
  async function fetchImageBlob(rawUrl){
    const user = (inputs.proxy.value||'').trim();
    const cand = [];
    if(user) cand.push(user + encodeURIComponent(rawUrl));
    try {
      const u = new URL(rawUrl);
      cand.push(`https://images.weserv.nl/?url=${u.host}${u.pathname}${u.search}`);
    } catch {}
    cand.push(rawUrl);

    for(const url of cand){
      try{
        const r = await fetch(url, { cache:'no-store' });
        if(!r.ok) continue;
        const b = await r.blob();
        if((b.type||'').startsWith('image/')) return b;
      }catch{}
    }
    throw new Error('画像取得失敗');
  }
  async function blobToBitmap(blob){ return await createImageBitmap(blob); }

  // ===== レンダリング =====
  function gridSize(){
    const COLS=+inputs.cols.value, ROWS=+inputs.rows.value, W=+inputs.tileW.value, H=+inputs.tileH.value, GAP=+inputs.gap.value;
    const gw = COLS*W + (COLS+1)*GAP;
    const gh = ROWS*H + (ROWS+1)*GAP;
    return {gw, gh, COLS, ROWS, W, H, GAP};
  }
  function clearCanvas(c){
    const cx = c.getContext('2d');
    cx.clearRect(0,0,c.width,c.height);
  }
  function roundRectPath(cx, x,y,w,h,r){
    cx.beginPath();
    cx.moveTo(x+r,y);
    cx.arcTo(x+w,y,x+w,y+h,r);
    cx.arcTo(x+w,y+h,x,y+h,r);
    cx.arcTo(x,y+h,x,y,r);
    cx.arcTo(x,y,x+w,y,r);
    cx.closePath();
  }

  async function ensureThumbnails(gift){
    if(gift._bmp) return gift._bmp;
    try{
      const blob = await fetchImageBlob(gift.imageUrl);
      gift._bmp = await blobToBitmap(blob);
      return gift._bmp;
    }catch{
      gift._bmp = null;
      return null;
    }
  }

  async function renderPreview(){
    const {gw,gh,COLS,ROWS,W,H,GAP} = gridSize();
    const offX=+inputs.offX.value, offY=+inputs.offY.value;
    const radius=+inputs.radius.value;
    const guide = inputs.guide.value==='ON';
    const iconScale = +inputs.iconScale.value/100;
    const pad = +inputs.iconPad.value;
    const centerX = inputs.labelAlignX.value;
    const centerY = inputs.labelAlignY.value;
    const lTxt = inputs.labelText.value;
    const lSize=+inputs.labelSize.value;
    const lColor=inputs.labelColor.value;
    const lStroke=inputs.labelStroke.checked;
    const lOffX=+inputs.labelOffX.value, lOffY=+inputs.labelOffY.value;

    // canvas size
    preview.width = gw + offX*2;
    preview.height= gh + offY*2;
    clearCanvas(preview);

    // 背景（プレビューは薄く）
    if(state.bgImg){
      ctx.globalAlpha = 1;
      ctx.drawImage(state.bgImg, 0, 0, preview.width, preview.height);
    }else{
      // 背景が無い時: 無地
      ctx.fillStyle = '#0a121a'; ctx.fillRect(0,0,preview.width, preview.height);
    }

    // ガイド枠
    if(guide){
      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const x = offX + GAP + c*(W+GAP);
          const y = offY + GAP + r*(H+GAP);
          roundRectPath(ctx, x,y,W,H,radius);
          ctx.fillStyle = 'rgba(0,0,0,0.25)';
          ctx.fill();
          ctx.strokeStyle = 'rgba(180,200,230,0.14)';
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }
    }

    // アイコン
    for(let i=0;i<state.picked.length;i++){
      const g = state.picked[i];
      if(!g) continue;
      const r = Math.floor(i / COLS);
      const c = i % COLS;
      if(r>=ROWS) break;

      const x = offX + GAP + c*(W+GAP);
      const y = offY + GAP + r*(H+GAP);

      const bmp = await ensureThumbnails(g);
      if(!bmp) continue;

      const areaW = Math.max(1, W - pad*2);
      const areaH = Math.max(1, H - pad*2);
      const ratio = Math.min(areaW / bmp.width, areaH / bmp.height) * iconScale;
      const iw = bmp.width * ratio;
      const ih = bmp.height * ratio;
      const ix = x + (W - iw)/2;
      const iy = y + (H - ih)/2;
      ctx.drawImage(bmp, ix, iy, iw, ih);
    }

    // テキスト（プレビューのみ）
    if(lTxt){
      ctx.save();
      ctx.font = `800 ${lSize}px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif`;
      ctx.fillStyle = lColor;
      ctx.textBaseline = 'middle';
      let tx = preview.width/2, ty = preview.height/2;
      if(centerX==='left') tx = 0 + 40;
      if(centerX==='right') tx = preview.width - 40;
      if(centerY==='top') ty = 0 + 40;
      if(centerY==='bottom') ty = preview.height - 40;
      tx += lOffX; ty += lOffY;
      ctx.textAlign = (centerX==='left'?'left':(centerX==='right'?'right':'center'));
      if(lStroke){
        ctx.lineWidth = Math.max(4, Math.floor(lSize/16));
        ctx.strokeStyle = 'rgba(0,0,0,0.75)';
        ctx.strokeText(lTxt, tx, ty);
      }
      ctx.fillText(lTxt, tx, ty);
      ctx.restore();
    }
  }

  function applyZoom(){
    const z = +inputs.zoom.value/100;
    state.previewScale = z;
    inputs.zoomVal.textContent = Math.round(z*100);
    document.getElementById('preview').style.transform = `scale(${z})`;
    document.getElementById('preview').style.transformOrigin = '0 0';
  }

  // ===== UI =====
  function renderGiftList(){
    listEl.innerHTML = '';
    for(const g of state.all){
      const b = document.createElement('button');
      b.className = 'gift';
      b.innerHTML = `<div class="nm">${escapeHtml(g.name)}</div><div class="co">🪙 ${g.cost}</div>`;
      b.onclick = ()=>{ state.picked.push({...g}); renderSlots(); renderPreview(); };
      listEl.appendChild(b);
    }
  }
  function renderSlots(){
    slotsEl.innerHTML = '';
    for(let i=0;i<state.picked.length;i++){
      const g = state.picked[i];
      const div = document.createElement('div');
      div.className = 'slot';
      const left = document.createElement('div');
      left.className = 'l';
      const img = document.createElement('img');
      img.alt = g.name;
      fetchImageBlob(g.imageUrl).then(b=>{
        const url = URL.createObjectURL(b); img.src = url; img.onload=()=>URL.revokeObjectURL(url);
      }).catch(()=>{});
      const cap = document.createElement('div');
      cap.innerHTML = `<div class="nm">${escapeHtml(g.name)}</div><div class="cap">🪙 ${g.cost} / ${g.id}</div>`;
      left.appendChild(img); left.appendChild(cap);
      const rm = document.createElement('div');
      rm.className = 'rm'; rm.textContent = '削除';
      rm.onclick = ()=>{ state.picked.splice(i,1); renderSlots(); renderPreview(); };
      div.appendChild(left); div.appendChild(rm);
      slotsEl.appendChild(div);
    }
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ===== PNG出力（アイコンのみ） =====
  async function exportPNG(){
    if(!state.bgImg){ alert('背景画像を選択してください'); return; }
    const {gw,gh,COLS,ROWS,W,H,GAP} = gridSize();
    const offX=+inputs.offX.value, offY=+inputs.offY.value;
    const iconScale = +inputs.iconScale.value/100;
    const pad = +inputs.iconPad.value;

    exportCV.width = state.bgImg.width;
    exportCV.height= state.bgImg.height;
    ectx.clearRect(0,0,exportCV.width,exportCV.height);
    // 背景に合わせてグリッドを中央に載せる
    const gridW = gw + offX*2;
    const gridH = gh + offY*2;
    const ox = (exportCV.width - gridW)/2;
    const oy = (exportCV.height - gridH)/2;

    // 背景
    ectx.drawImage(state.bgImg, 0, 0);

    // アイコン
    for(let i=0;i<state.picked.length;i++){
      const g = state.picked[i];
      if(!g) continue;
      const r = Math.floor(i / COLS);
      const c = i % COLS;
      if(r>=ROWS) break;

      const x = ox + offX + GAP + c*(W+GAP);
      const y = oy + offY + GAP + r*(H+GAP);

      try{
        const blob = await fetchImageBlob(g.imageUrl);
        const bmp = await blobToBitmap(blob);
        const areaW = Math.max(1, W - pad*2);
        const areaH = Math.max(1, H - pad*2);
        const ratio = Math.min(areaW / bmp.width, areaH / bmp.height) * iconScale;
        const iw = bmp.width * ratio;
        const ih = bmp.height * ratio;
        const ix = x + (W - iw)/2;
        const iy = y + (H - ih)/2;
        ectx.drawImage(bmp, ix, iy, iw, ih);
      }catch{}
    }

    try{
      const url = exportCV.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'gift_board.png'; a.click();
    }catch{
      alert('PNG生成に失敗しました');
    }
  }

  document.getElementById('pickBgBtn').addEventListener('click', ()=> document.getElementById('bgFile').click());
  document.getElementById('bgFile').addEventListener('change', async (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const img = new Image();
    img.onload = ()=>{ state.bgImg = img; renderPreview(); };
    img.onerror = ()=> alert('背景画像の読み込みに失敗しました');
    img.src = URL.createObjectURL(f);
  });

  document.getElementById('loadBtn').onclick = async ()=>{
    try{
      state.picked = []; renderSlots();
      await loadSheet();
      renderGiftList();
      renderPreview();
    }catch(e){
      console.error(e);
      alert('シートの読み込みに失敗しました。権限とURLを確認してください。');
    }
  };
  document.getElementById('rerender').onclick = renderPreview;
  document.getElementById('saveBtn').onclick = exportPNG;
  document.getElementById('clearBtn').onclick = ()=>{ state.picked=[]; renderSlots(); renderPreview(); };
  inputs.zoom.addEventListener('input', applyZoom);
  for(const k of ['cols','rows','tileW','tileH','gap','radius','offX','offY','guide','iconScale','iconPad','overflow','labelText','labelSize','labelColor','labelStroke','labelAlignX','labelAlignY','labelOffX','labelOffY']){
    inputs[k].addEventListener('input', ()=>{ renderPreview(); });
  }
  applyZoom();
  renderPreview();
  document.getElementById('loadBtn').click(); // 初回自動ロード
})();
</script>
</body>
</html>
