<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gift Board Generator (fixed)</title>
<style>
  :root{
    --bg:#0f172a;
    --panel:#111827;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0b1220;color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  header{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid #1f2937;background:#0f172a;position:sticky;top:0;z-index:10}
  header h1{font-size:16px;margin:0;color:#c7d2fe}
  .row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:.25rem}
  .field label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="number"],select{background:#0b1220;border:1px solid #233044;color:var(--text);padding:.45rem .6rem;border-radius:.5rem;min-width:140px}
  button{background:#1d4ed8;border:0;color:white;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer}
  button.ghost{background:#374151}
  button:disabled{opacity:.5;cursor:not-allowed}
  main{display:grid;grid-template-columns: 1fr 320px;gap:1rem;padding:1rem}
  @media (max-width: 1100px){ main{grid-template-columns: 1fr} }
  .panel{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.5rem;max-height:60vh;overflow:auto}
  .gift{border:1px solid #1f2937;border-radius:10px;padding:.5rem;display:flex;justify-content:space-between;align-items:center;background:#0b1220;cursor:pointer}
  .gift:hover{outline:2px solid #2563eb}
  .pill{font-size:11px;color:#fbbf24}
  canvas{width:100%;height:auto;background:#0a0f1c;border-radius:12px;border:1px solid #1f2937}
  .stack{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .grid-controls{display:grid;grid-template-columns:repeat(6,minmax(120px,1fr));gap:.5rem}
  @media (max-width: 900px){ .grid-controls{grid-template-columns:repeat(2,minmax(120px,1fr))} }
  .placed{display:flex;gap:.5rem;overflow:auto;white-space:nowrap;padding:.5rem 0}
  .chip{background:#0b1220;border:1px solid #1f2937;padding:.35rem .6rem;border-radius:999px}
</style>
</head>
<body>
<header>
  <h1>Gift Board Generator</h1>
  <div class="row">
    <div class="field"><label>（固定）Sheet ID</label><input type="text" id="sheetId" value="15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U"></div>
    <div class="field"><label>（固定）gid</label><input type="text" id="gid" value="1487601753"></div>
    <div class="field"><label>（既定）CORSプロキシ</label><input type="text" id="proxy" value="https://blue-field-b0dc.katakura-yuuki-1121.workers.dev/?url="></div>
    <button id="load">読み込む</button>
    <button id="save" class="ghost">PNGとして保存</button>
  </div>
</header>

<main>
  <section class="panel">
    <div class="stack" style="justify-content:space-between;margin-bottom:.5rem">
      <div class="stack">
        <div class="field">
          <label>背景画像（ローカル）</label>
          <input type="file" id="bgfile" accept="image/*">
        </div>
        <div class="field">
          <label>背景URL</label>
          <input type="text" id="bgurl" placeholder="https://example.com/bg.png">
        </div>
        <div class="field">
          <label>プレビューでテキスト表示</label>
          <select id="previewText">
            <option value="on" selected>ON</option>
            <option value="off">OFF</option>
          </select>
        </div>
      </div>
      <div class="small">出力は幅1080pxに自動スケール（余白なし）</div>
    </div>

    <div class="grid-controls">
      <div class="field"><label>列 (COLS)</label><input type="number" id="cols" value="6" min="1"></div>
      <div class="field"><label>行 (ROWS)</label><input type="number" id="rows" value="3" min="1"></div>
      <div class="field"><label>枠幅 TILE_W</label><input type="number" id="tileW" value="320" min="40"></div>
      <div class="field"><label>枠高 TILE_H</label><input type="number" id="tileH" value="180" min="40"></div>
      <div class="field"><label>枠間 GAP</label><input type="number" id="gap" value="20" min="0"></div>
      <div class="field"><label>角丸 px</label><input type="number" id="r" value="18" min="0"></div>
    </div>

    <div class="stack" style="margin:.75rem 0">
      <div class="field"><label>アイコン倍率（％／タイル基準）</label><input type="range" id="scale" min="50" max="180" value="100"></div>
      <div class="field"><label>アイコン余白 px</label><input type="number" id="pad" min="0" value="14"></div>
      <div class="field"><label>テキスト</label><input type="text" id="slotText" value=""></div>
      <div class="field"><label>テキストサイズ px</label><input type="number" id="txtSize" min="10" value="86"></div>
    </div>

    <canvas id="preview" width="1280" height="720"></canvas>
    <div class="small" id="wh"></div>

    <div style="margin-top:.5rem">
      <div class="small">配置中（クリックで削除）</div>
      <div id="placed" class="placed"></div>
    </div>
  </section>

  <aside class="panel">
    <div class="row" style="justify-content:space-between;margin-bottom:.5rem">
      <div>ギフト一覧（クリックで追加）</div>
      <button id="clear" class="ghost">クリア</button>
    </div>
    <div id="giftList" class="list"></div>
    <div class="small" style="margin-top:.5rem">※ 必要カラム：Gift ID / Gift Name / Gift Cost / Gift Image URL</div>
  </aside>
</main>

<script>
// ---- Helpers ---------------------------------------------------------------
const $ = sel => document.querySelector(sel);
const giftListEl = $('#giftList');
const preview = $('#preview');
const ctx = preview.getContext('2d');

let gifts = [];          // {id,name,cost,img}
let placed = [];         // {gift, sx, sy, scale, text}
let bgImage = null;      // Image element
let bgURL = '';          // remote url (proxied)
let board = {cols:6, rows:3, w:320, h:180, gap:20, r:18, pad:14, scale:1.0};

function proxify(url){
  if(!url) return '';
  const p = $('#proxy').value.trim();
  if(url.startsWith('data:')) return url;
  if(p && !url.startsWith(p)){
    const join = p.includes('?') ? (p.endsWith('=')?'':'=') : (p.endsWith('/')?'':'/');
    return p + (p.endsWith('=')? '': join) + encodeURIComponent(url);
  }
  return url;
}

// CSV parser (quoted cells supported)
function parseCSV(text){
  const rows = [];
  let i=0, cell='', row=[], inq=false;
  while(i < text.length){
    const ch = text[i];
    if(ch === '"'){
      if(inq && text[i+1] === '"'){ cell += '"'; i+=2; }
      else { inq = !inq; i++; }
    }else if(ch === ',' && !inq){ row.push(cell); cell=''; i++; }
    else if((ch === '\n' || ch === '\r') && !inq){
      // push row only if anything read
      if(ch === '\r' && text[i+1] === '\n') i++;
      row.push(cell); rows.push(row); cell=''; row=[]; i++;
    }else{ cell += ch; i++; }
  }
  if(cell.length || row.length) { row.push(cell); rows.push(row); }
  return rows;
}

// Load sheet
async function loadSheet(){
  const sheetId = $('#sheetId').value.trim();
  const gid = $('#gid').value.trim();
  const base = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
  const url = proxify(base);
  try{
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const csv = await res.text();
    const rows = parseCSV(csv).filter(r=>r.length>0);
    // find header indexes
    const header = rows[0].map(h=>h.trim().toLowerCase());
    const iId   = header.findIndex(h=>h.includes('gift id'));
    const iName = header.findIndex(h=>h.includes('gift name'));
    const iCost = header.findIndex(h=>h.includes('gift cost'));
    const iImg  = header.findIndex(h=>h.includes('gift image'));
    gifts = rows.slice(1).map(r=> ({
      id: r[iId]||'',
      name: r[iName]||'',
      cost: r[iCost]||'',
      img: (r[iImg]||'').replace(/^=HYPERLINK\\(\\s*"([^"]+)".*$/i, '$1')
    })).filter(g=>g.name && g.img);
    renderGiftList();
  }catch(e){
    alert('シート取得に失敗（CORS/権限/URL）\\n'+e);
    console.error(e);
  }
}

function renderGiftList(){
  giftListEl.innerHTML = '';
  for(const g of gifts){
    const el = document.createElement('button');
    el.className = 'gift';
    el.innerHTML = `<span>${g.name}</span><span class="pill">🪙 ${g.cost||''}</span>`;
    el.onclick = ()=>{
      placed.push({gift:g, dx:0, dy:0, scale:+$('#scale').value/100, text:$('#slotText').value});
      renderPlacedChips();
      render();
    };
    giftListEl.appendChild(el);
  }
}

function renderPlacedChips(){
  const wrap = $('#placed');
  wrap.innerHTML = '';
  placed.forEach((p,idx)=>{
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = `${idx+1}. ${p.gift.name}`;
    b.title = 'クリックで削除';
    b.onclick = ()=>{ placed.splice(idx,1); renderPlacedChips(); render(); };
    wrap.appendChild(b);
  });
}

function roundRect(ctx, x, y, w, h, r){
  r = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

function drawBackground(ctx, W, H){
  if(!bgImage){ ctx.fillStyle = '#0a1221'; ctx.fillRect(0,0,W,H); return; }
  // cover fit
  const iw = bgImage.naturalWidth, ih = bgImage.naturalHeight;
  const scale = Math.max(W/iw, H/ih);
  const dw = iw*scale, dh = ih*scale;
  const dx = (W-dw)/2, dy = (H-dh)/2;
  ctx.drawImage(bgImage, dx, dy, dw, dh);
}

async function loadImage(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

async function render(toPNG=false){
  // read controls
  board.cols = +$('#cols').value;
  board.rows = +$('#rows').value;
  board.w = +$('#tileW').value;
  board.h = +$('#tileH').value;
  board.gap = +$('#gap').value;
  board.r = +$('#r').value;
  board.pad = +$('#pad').value;
  const drawText = $('#previewText').value === 'on';
  const txtSize = +$('#txtSize').value;
  // compute board size
  const W = board.cols*board.w + (board.cols-1)*board.gap;
  const H = board.rows*board.h + (board.rows-1)*board.gap;
  // set canvas size for crisp preview
  preview.width = W;
  preview.height = H;
  $('#wh').textContent = `描画サイズ: ${W}×${H} → 保存時 1080px幅にスケール`;

  // background
  drawBackground(ctx, W, H);

  // grid
  const R = board.r;
  for(let y=0;y<board.rows;y++){
    for(let x=0;x<board.cols;x++){
      const left = x*(board.w+board.gap);
      const top  = y*(board.h+board.gap);
      ctx.save();
      roundRect(ctx, left, top, board.w, board.h, R);
      ctx.clip();
      // subtle inner panel
      ctx.fillStyle = 'rgba(255,255,255,0.02)';
      ctx.fillRect(left, top, board.w, board.h);
      ctx.restore();
      // outline
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 2;
      roundRect(ctx, left, top, board.w, board.h, R);
      ctx.stroke();
    }
  }

  // draw each placed gift into grid order (left to right, top to bottom)
  // If more placed than cells, render within first N cells
  const cells = [];
  for(let y=0;y<board.rows;y++)
    for(let x=0;x<board.cols;x++)
      cells.push({x,y,left:x*(board.w+board.gap),top:y*(board.h+board.gap)});

  for(let i=0;i<Math.min(placed.length, cells.length);i++){
    const cell = cells[i];
    const p = placed[i];
    // load image (with proxy) & cache on object
    if(!p._img && p.gift.img){
      try{ p._img = await loadImage(proxify(p.gift.img)); }
      catch(e){ console.warn('img load failed', p.gift.img); p._img=null; }
    }
    if(p._img){
      const iw = p._img.naturalWidth, ih = p._img.naturalHeight;
      const scale = p.scale || (+$('#scale').value/100);
      // fit by shorter side inside tile minus pad
      const tw = board.w - board.pad*2;
      const th = board.h - board.pad*2;
      const s = Math.min(tw/iw, th/ih) * scale;
      const dw = iw*s, dh = ih*s;
      const cx = cell.left + board.w/2 + (p.dx||0);
      const cy = cell.top  + board.h/2 + (p.dy||0);
      ctx.drawImage(p._img, cx - dw/2, cy - dh/2, dw, dh);
    }
    if(drawText && p.text){
      ctx.font = `600 ${txtSize}px system-ui, sans-serif`;
      ctx.fillStyle = 'white';
      ctx.strokeStyle = 'rgba(0,0,0,.8)';
      ctx.lineWidth = Math.max(2, txtSize*0.12);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const tx = cell.left + board.w/2;
      const ty = cell.top + board.h/2;
      ctx.strokeText(p.text, tx, ty);
      ctx.fillText(p.text, tx, ty);
    }
  }

  if(toPNG){
    // composite → scale to 1080 width
    const outW = 1080;
    const scale = outW / W;
    const outH = Math.round(H * scale);
    const out = document.createElement('canvas');
    out.width = outW; out.height = outH;
    const octx = out.getContext('2d');
    octx.imageSmoothingEnabled = true;
    octx.imageSmoothingQuality = 'high';
    octx.drawImage(preview, 0, 0, outW, outH);
    const a = document.createElement('a');
    a.download = 'gift_board.png';
    a.href = out.toDataURL('image/png');
    a.click();
  }
}

// events
$('#load').onclick = loadSheet;
$('#save').onclick = ()=>render(true);
document.querySelectorAll('#cols,#rows,#tileW,#tileH,#gap,#r,#pad,#scale,#txtSize,#previewText').forEach(el=>{
  el.addEventListener('input', ()=>render());
});

$('#bgfile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  bgImage = await loadImage(url);
  render();
});
$('#bgurl').addEventListener('change', async (e)=>{
  const url = proxify(e.target.value.trim());
  if(!url) return;
  try{ bgImage = await loadImage(url); render(); }
  catch(err){ alert('背景の読み込みに失敗しました'); }
});
$('#clear').onclick = ()=>{ placed = []; renderPlacedChips(); render(); };

// initial
render();
</script>
</body>
</html>
