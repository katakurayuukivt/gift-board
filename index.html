<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gift Board Generator</title>
  <!-- GiftBoard build 2025-08-12 (Pages-ready, JSONP fallback, no TS casts) -->
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    html,body{height:100%}
    .scrollbar::-webkit-scrollbar{height:10px;width:10px}
    .scrollbar::-webkit-scrollbar-thumb{background:#2b3446;border-radius:6px}
    .scrollbar::-webkit-scrollbar-track{background:#0e1420}
    input[type="file"].file-hide{position:absolute;left:-9999px}
  </style>
</head>
<body class="bg-slate-900 text-slate-200">
  <div class="max-w-[1400px] mx-auto p-4 space-y-4">

    <!-- Top controls -->
    <div class="grid grid-cols-1 xl:grid-cols-12 gap-3 items-end">
      <div class="xl:col-span-3">
        <label class="block text-xs text-slate-400">Sheet ID（固定）</label>
        <input id="sheetId" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U" readonly />
      </div>
      <div class="xl:col-span-2">
        <label class="block text-xs text-slate-400">gid（固定）</label>
        <input id="gid" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="1487601753" readonly />
      </div>
      <div class="xl:col-span-4">
        <label class="block text-xs text-slate-400">（任意）公開CSV直リンク（あるなら最優先）</label>
        <input id="csvUrl" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv" />
      </div>
      <div class="xl:col-span-3">
        <label class="block text-xs text-slate-400">CORSプロキシURL（既定）</label>
        <input id="proxy" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="https://api.allorigins.win/raw?url=" />
      </div>

      <div class="xl:col-span-3 flex gap-2">
        <button id="loadBtn" class="px-4 py-2 rounded bg-sky-500 text-slate-900 font-bold">読み込む</button>
        <label class="relative px-4 py-2 rounded bg-slate-700 cursor-pointer">
          <input id="bgFile" type="file" accept="image/*" class="file-hide" />
          <span>背景画像を選ぶ</span>
        </label>
      </div>
      <div class="xl:col-span-4 flex gap-2">
        <label class="relative px-4 py-2 rounded bg-slate-700 cursor-pointer">
          <input id="fontFile" type="file" accept=".ttf,.otf,.woff,.woff2" class="file-hide" />
          <span>フォントを追加</span>
        </label>
        <select id="fontSel" class="px-3 py-2 rounded bg-slate-800 border border-slate-700">
          <option value="system-ui" selected>system-ui</option>
        </select>
      </div>
      <div class="xl:col-span-5 flex gap-2 justify-end">
        <button id="saveBtn" class="px-4 py-2 rounded bg-emerald-400 text-slate-900 font-bold">PNGとして保存</button>
      </div>
    </div>

    <!-- Knobs -->
    <div class="grid grid-cols-2 md:grid-cols-8 gap-3">
      <div><label class="text-xs text-slate-400">列(COLS)</label><input id="cols" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="6" /></div>
      <div><label class="text-xs text-slate-400">行(ROWS)</label><input id="rows" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="3" /></div>
      <div><label class="text-xs text-slate-400">TILE_W</label><input id="tileW" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="320" /></div>
      <div><label class="text-xs text-slate-400">TILE_H</label><input id="tileH" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="180" /></div>
      <div><label class="text-xs text-slate-400">GAP</label><input id="gap" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="20" /></div>
      <div><label class="text-xs text-slate-400">角丸</label><input id="radius" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="18" /></div>
      <div><label class="text-xs text-slate-400">オフセットX</label><input id="offX" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="0" /></div>
      <div><label class="text-xs text-slate-400">オフセットY</label><input id="offY" type="number" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" value="0" /></div>
    </div>

    <!-- Preview + right panel -->
    <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
      <!-- Left: preview fixed width -->
      <div class="xl:col-span-8 space-y-3">
        <div class="flex items-center gap-3">
          <label class="text-xs text-slate-400">ズーム</label>
          <input id="zoom" type="range" min="50" max="200" value="100" class="w-64" />
          <button id="refreshBtn" class="px-3 py-1 bg-slate-700 rounded">更新</button>
          <label class="text-xs flex items-center gap-2"><input id="showTextPreview" type="checkbox" class="scale-125" /> プレビューでテキスト表示</label>
        </div>
        <div class="relative bg-slate-950 rounded-xl border border-slate-800 p-3">
          <canvas id="preview" class="w-full h-auto block mx-auto"></canvas>
          <div class="absolute right-2 top-2 text-xs text-slate-400" id="bgInfo"></div>
        </div>

        <!-- Picked bar (one line under preview) -->
        <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold">配置中（ドラッグで並び替え・クリックで編集）</div>
            <button id="clearBtn" class="text-xs px-2 py-1 bg-slate-700 rounded">クリア</button>
          </div>
          <div id="pickedBar" class="flex gap-2 overflow-x-auto scrollbar min-h-[96px]"></div>
        </div>
      </div>

      <!-- Right: list + editor -->
      <div class="xl:col-span-4 space-y-4">
        <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-3">
          <div class="font-bold mb-2">ギフト一覧（クリックで追加）</div>
          <div id="giftList" class="grid grid-cols-2 md:grid-cols-2 gap-2 max-h-[520px] overflow-auto scrollbar"></div>
          <div class="text-[11px] text-slate-400 mt-2">必要カラム：Gift ID / Gift Name / Gift Cost / Gift Image URL</div>
        </div>

        <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-3 hidden" id="slotEditorWrap">
          <div class="font-bold mb-2" id="slotEditorTitle">スロット編集</div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-400">テキスト</label>
              <input id="edText" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" placeholder="スロットの見出し（任意）" />
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="text-xs text-slate-400">文字サイズ(px)</label><input id="edTextSize" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="86" /></div>
              <div><label class="text-xs text-slate-400">文字色</label><input id="edColor" type="color" class="w-full h-10 bg-slate-900 border border-slate-700 rounded" value="#ffffff" /></div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="text-xs text-slate-400">文字Xオフ</label><input id="edTextX" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="0" /></div>
              <div><label class="text-xs text-slate-400">文字Yオフ</label><input id="edTextY" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="0" /></div>
            </div>
            <div class="grid grid-cols-3 gap-2 items-end">
              <div><label class="text-xs text-slate-400">アイコン倍率(%)</label><input id="edIconScale" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="100" /></div>
              <div><label class="text-xs text-slate-400">アイコンX</label><input id="edIconX" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="0" /></div>
              <div><label class="text-xs text-slate-400">アイコンY</label><input id="edIconY" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="0" /></div>
            </div>
            <div class="col-span-2 grid grid-cols-4 gap-2 items-end">
              <label class="relative px-3 py-2 rounded bg-slate-700 cursor-pointer text-center">
                <input id="edOverlayFile" type="file" accept="image/*" class="file-hide" />
                <span>追加画像を選択</span>
              </label>
              <div><label class="text-xs text-slate-400">追加倍率(%)</label><input id="edOvScale" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="100" /></div>
              <div><label class="text-xs text-slate-400">追加X</label><input id="edOvX" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="0" /></div>
              <div><label class="text-xs text-slate-400">追加Y</label><input id="edOvY" type="number" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1" value="0" /></div>
            </div>
            <div class="col-span-2 flex gap-2">
              <label class="text-xs flex items-center gap-2"><input id="edTextPreview" type="checkbox" class="scale-125" /> プレビューでテキスト表示</label>
              <button id="edDelete" class="ml-auto px-3 py-2 bg-rose-500 text-slate-900 rounded">このスロットを削除</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <canvas id="exportCanvas" class="hidden"></canvas>
  </div>

<script>
(() => {
  // ===== constants & state =====
  const DEFAULT_SHEET = "15QtBjbdETvUNL64JF46MvTvkfXaZI_jAtTphKQH6Y5U";
  const DEFAULT_GID   = "1487601753";
  const DEFAULT_PROXY = "https://api.allorigins.win/raw?url=";
  const PREVIEW_BASE_W = 1080; // TikTok 基準幅

  const imageCache = new Map();
  let gifts = [];
  let picked = [];
  let bgImg = null;
  let userFont = null;
  let editingIndex = -1;

  // ===== DOM =====
  const el = (id) => document.getElementById(id);
  const sheetId = el('sheetId'), gid = el('gid'), csvUrl = el('csvUrl'), proxy = el('proxy');
  const cols = el('cols'), rows = el('rows'), tileW = el('tileW'), tileH = el('tileH'), gap = el('gap'), radius = el('radius'), offX = el('offX'), offY = el('offY');
  const preview = el('preview'), exportCanvas = el('exportCanvas');
  const zoom = el('zoom'), refreshBtn = el('refreshBtn'), showTextPreview = el('showTextPreview');
  const bgInfo = el('bgInfo'), pickedBar = el('pickedBar'), giftList = el('giftList');
  const slotEditorWrap = el('slotEditorWrap'); const slotEditorTitle = el('slotEditorTitle');
  const ed = {
    text: el('edText'), textSize: el('edTextSize'), color: el('edColor'), textX: el('edTextX'), textY: el('edTextY'),
    iconScale: el('edIconScale'), iconX: el('edIconX'), iconY: el('edIconY'),
    ovFile: el('edOverlayFile'), ovScale: el('edOvScale'), ovX: el('edOvX'), ovY: el('edOvY'),
    textPreview: el('edTextPreview'), del: el('edDelete')
  };

  // defaults
  sheetId.value = DEFAULT_SHEET; gid.value = DEFAULT_GID; proxy.value = DEFAULT_PROXY;

  // ===== utils =====
  function px(n){ return Number(n||0) || 0; }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function csvToRows(csvText){
    const rows=[]; let i=0, cell='', row=[], inQ=false;
    while(i<csvText.length){
      const ch = csvText[i];
      if(inQ){
        if(ch === '"'){
          if(csvText[i+1] === '"'){ cell+='"'; i+=2; }
          else { inQ=false; i++; }
        }else{ cell+=ch; i++; }
        continue;
      }
      if(ch === '"'){ inQ=true; i++; continue; }
      if(ch === ','){ row.push(cell); cell=''; i++; continue; }
      if(ch === '\n'){ row.push(cell); rows.push(row); cell=''; row=[]; i++; continue; }
      if(ch === '\r'){ i++; continue; }
      const code = ch.charCodeAt(0);
      if(code===0xFEFF || code===0x200B || code===0x200C || code===0x200D){ i++; continue; } // BOM/ZW*
      cell += ch; i++;
    }
    row.push(cell); rows.push(row);
    return rows;
  }

  function peelHyperlinkCell(s){
    if(!s) return '';
    s = String(s).trim();
    const up = s.toUpperCase();
    if(!up.startsWith('=HYPERLINK(')) return s;
    let i = s.indexOf('(');
    if(i<0) return s; i++;
    if(s[i] !== '"') return s; i++;
    let url='';
    while(i < s.length){
      const ch = s[i];
      if(ch === '"'){
        if(s[i+1] === '"'){ url+='"'; i+=2; continue; }
        break;
      }
      url += ch; i++;
    }
    return url;
  }

  async function fetchTextWithProxies(url, userProxy){
    const cands = [];
    if(userProxy) cands.push(userProxy + encodeURIComponent(url));
    cands.push(url);
    cands.push('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url));
    cands.push('https://cors.isomorphic-git.org/' + url);

    for(const u of cands){
      try{
        const r = await fetch(u, {cache:'no-store'});
        if(!r.ok) continue;
        return await r.text();
      }catch(e){}
    }
    throw new Error('fetch failed');
  }

  // ---- GViz JSONP fallback (no CORS needed) ----
  function loadSheetViaGViz(sheetId, gid, timeoutMs = 12000) {
    return new Promise((resolve, reject) => {
      const cbName = "__gviz_cb_" + Math.random().toString(36).slice(2);
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?gid=${gid}&tqx=out:json;responseHandler=${cbName}`;
      const s = document.createElement("script");
      let timer = setTimeout(() => { cleanup(); reject(new Error("GViz timeout")); }, timeoutMs);
      function cleanup(){ clearTimeout(timer); delete window[cbName]; if (s.parentNode) s.parentNode.removeChild(s); }
      window[cbName] = (resp) => {
        try {
          const table = resp.table;
          const header = table.cols.map(c => (c.label || "").trim());
          const map = Object.fromEntries(header.map((h,i)=>[h,i]));
          const rows = table.rows.map(r => r.c.map(c => (c ? c.v : "")));
          const data = rows.map(r => ({
            id:   r[map["Gift ID"]] || "",
            name: r[map["Gift Name"]] || "",
            cost: Number(r[map["Gift Cost"]] || 0),
            imageUrl: peelHyperlinkCell(r[map["Gift Image URL"]] || "")
          })).filter(g => g.id && g.name && g.imageUrl);
          cleanup(); resolve(data);
        } catch (e) { cleanup(); reject(e); }
      };
      s.src = url;
      s.onerror = () => { cleanup(); reject(new Error("GViz load error")); };
      document.head.appendChild(s);
    });
  }

  async function loadSheet(sheetId, gid){
    // Try CSV first (fast/clean), then fallback to GViz JSONP (no CORS)
    try{
      const base = (csvUrl && csvUrl.value.trim())
        ? csvUrl.value.trim()
        : `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
      const text = await fetchTextWithProxies(base, (proxy && proxy.value || "").trim());
      const rows = csvToRows(text);
      const header = rows[0].map(h => h.trim());
      const map = Object.fromEntries(header.map((h,i)=>[h,i]));
      return rows.slice(1).map(r => ({
        id: r[map["Gift ID"]] || "",
        name: r[map["Gift Name"]] || "",
        cost: Number(r[map["Gift Cost"]] || 0),
        imageUrl: peelHyperlinkCell(r[map["Gift Image URL"]] || "")
      })).filter(g => g.id && g.name && g.imageUrl);
    }catch(e){
      console.warn("CSV 失敗 → GViz にフォールバック:", e);
      return await loadSheetViaGViz(sheetId, gid);
    }
  }

  async function fetchImageBitmap(url, userProxy){
    if(imageCache.has(url)) return imageCache.get(url);
    const p = (async () => {
      const cands = [];
      if(userProxy) cands.push(userProxy + encodeURIComponent(url));
      try{
        const u = new URL(url);
        const path = u.host + u.pathname + (u.search||'');
        cands.push('https://images.weserv.nl/?url=' + encodeURIComponent(path));
      }catch{}
      cands.push('https://cors.isomorphic-git.org/' + url);
      cands.push(url);
      for(const u of cands){
        try{
          const r = await fetch(u, {cache:'no-store'});
          if(!r.ok) continue;
          const b = await r.blob();
          if(!(b.type||'').startsWith('image/')) continue;
          return await createImageBitmap(b);
        }catch(e){}
      }
      throw new Error('画像取得失敗: '+url);
    })();
    imageCache.set(url, p);
    return p;
  }

  // ===== drawing helpers =====
  function gridSize(){
    const W = px(cols.value)*px(tileW.value) + (px(cols.value)+1)*px(gap.value);
    const H = px(rows.value)*px(tileH.value) + (px(rows.value)+1)*px(gap.value);
    return {W,H};
  }

  function drawGuide(ctx, x0, y0){
    const COLS = px(cols.value), ROWS = px(rows.value);
    const TW = px(tileW.value), TH = px(tileH.value), GAP = px(gap.value), R = px(radius.value);
    ctx.save();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const x = x0 + GAP + c*(TW+GAP);
        const y = y0 + GAP + r*(TH+GAP);
        ctx.beginPath();
        const rr = Math.min(R, TW/2, TH/2);
        ctx.moveTo(x+rr,y);
        ctx.arcTo(x+TW,y,x+TW,y+TH,rr);
        ctx.arcTo(x+TW,y+TH,x,y+TH,rr);
        ctx.arcTo(x,y+TH,x,y,rr);
        ctx.arcTo(x,y,x+TW,y,rr);
        ctx.closePath();
        ctx.stroke();
      }
    }
    ctx.restore();
  }

  async function render(toExport=false){
    const ctx = preview.getContext('2d');
    const {W,H} = gridSize();
    const scale = PREVIEW_BASE_W / W;
    const viewW = Math.round(W * scale * (px(zoom.value)/100));
    const viewH = Math.round(H * scale * (px(zoom.value)/100));
    preview.width = viewW;
    preview.height = viewH;

    const buf = document.createElement('canvas');
    buf.width = W; buf.height = H;
    const bctx = buf.getContext('2d');
    bctx.fillStyle = '#0b1320';
    bctx.fillRect(0,0,W,H);
    if(bgImg){ bctx.drawImage(bgImg, 0, 0, W, H); }

    drawGuide(bctx, px(offX.value), px(offY.value));

    const COLS = px(cols.value), TW = px(tileW.value), TH = px(tileH.value), GAP = px(gap.value);

    for(let i=0;i<Math.min(picked.length, COLS*px(rows.value)); i++){
      const r = Math.floor(i/COLS), c = i%COLS;
      const x = px(offX.value) + GAP + c*(TW+GAP);
      const y = px(offY.value) + GAP + r*(TH+GAP);

      const it = picked[i];
      if(!it) continue;

      // base gift icon (bottom)
      try{
        const bmp = await fetchImageBitmap(it.gift.imageUrl, proxy.value.trim());
        const scalePct = (Number(it.iconScale)||100)/100;
        const maxW = TW - 16, maxH = TH - 16;
        const ratio = Math.min(maxW/bmp.width, maxH/bmp.height) * scalePct;
        const iw = bmp.width * ratio, ih = bmp.height * ratio;
        const ix = x + (TW - iw)/2 + px(it.iconX);
        const iy = y + (TH - ih)/2 + px(it.iconY);
        bctx.drawImage(bmp, ix, iy, iw, ih);
      }catch(e){}

      // overlay image (middle)
      if(it.overlay && it.overlay.url){
        try{
          const img = await (async () => {
            if(imageCache.has(it.overlay.url)) return imageCache.get(it.overlay.url);
            const p = createImageBitmap(await (await fetch(it.overlay.url)).blob());
            imageCache.set(it.overlay.url, p);
            return p;
          })();
          const sc = (Number(it.overlay.scale)||100)/100;
          const iw = img.width * sc, ih = img.height * sc;
          const ix = x + (TW - iw)/2 + px(it.overlay.x);
          const iy = y + (TH - ih)/2 + px(it.overlay.y);
          bctx.drawImage(img, ix, iy, iw, ih);
        }catch(e){}
      }

      // text (top)
      if( (toExport || showTextPreview.checked || it.showTextPreview) && it.text ){
        bctx.save();
        bctx.fillStyle = it.color || '#ffffff';
        bctx.strokeStyle = 'rgba(0,0,0,.9)';
        bctx.lineWidth = Math.max(2, Math.floor((Number(it.textSize)||86)/16));
        bctx.font = `900 ${Math.max(12, Number(it.textSize)||86)}px ${userFont ? userFont.name : 'system-ui'}`;
        bctx.textAlign = 'center';
        bctx.textBaseline = 'middle';
        const tx = x + TW/2 + px(it.textX);
        const ty = y + TH/2 + px(it.textY);
        bctx.strokeText(it.text, tx, ty);
        bctx.fillText(it.text, tx, ty);
        bctx.restore();
      }
    }

    ctx.imageSmoothingEnabled = true;
    ctx.clearRect(0,0,preview.width,preview.height);
    ctx.drawImage(buf, 0, 0, preview.width, preview.height);
  }

  // ===== UI renderers =====
  function renderGiftList(){
    giftList.innerHTML = '';
    for(const g of gifts){
      const b = document.createElement('button');
      b.className = 'bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg px-3 py-2 text-left';
      b.innerHTML = `<div class="font-bold truncate">${escapeHtml(g.name)}</div>
                     <div class="text-xs text-slate-400">🪙 ${g.cost}</div>`;
      b.onclick = () => {
        picked.push({
          gift:g, text:'', textSize:86, color:'#ffffff', textX:0, textY:0,
          iconScale:100, iconX:0, iconY:0,
          overlay:{url:'',scale:100,x:0,y:0},
          showTextPreview:false
        });
        renderPickedBar();
        render();
      };
      giftList.appendChild(b);
    }
  }

  function renderPickedBar(){
    pickedBar.innerHTML='';
    picked.forEach((it, idx) => {
      const d = document.createElement('div');
      d.className = 'min-w-[120px] max-w-[160px] flex-shrink-0 rounded-lg bg-slate-800/60 border border-slate-700 p-2 cursor-pointer';
      d.innerHTML = `<div class="text-[10px] text-slate-400 mb-1">#${idx+1}</div>
                     <div class="font-bold text-sm truncate">${escapeHtml(it.gift.name)}</div>`;
      d.onclick = () => openEditor(idx);
      pickedBar.appendChild(d);
    });
    Sortable.create(pickedBar, {
      animation: 150,
      onEnd: (evt) => {
        const [moved] = picked.splice(evt.oldIndex,1);
        picked.splice(evt.newIndex,0,moved);
        renderPickedBar();
        render();
      }
    });
  }

  function openEditor(i){
    editingIndex = i;
    const it = picked[i];
    slotEditorWrap.classList.remove('hidden');
    slotEditorTitle.textContent = `スロット編集 #${i+1}（${it.gift.name}）`;
    ed.text.value = it.text||'';
    ed.textSize.value = it.textSize||86;
    ed.color.value = it.color||'#ffffff';
    ed.textX.value = it.textX||0;
    ed.textY.value = it.textY||0;
    ed.iconScale.value = it.iconScale||100;
    ed.iconX.value = it.iconX||0;
    ed.iconY.value = it.iconY||0;
    ed.ovScale.value = (it.overlay&&it.overlay.scale)||100;
    ed.ovX.value = (it.overlay&&it.overlay.x)||0;
    ed.ovY.value = (it.overlay&&it.overlay.y)||0;
    ed.textPreview.checked = !!it.showTextPreview;
  }

  function bindEditor(){
    const upd = () => {
      if(editingIndex<0) return;
      const it = picked[editingIndex];
      it.text = ed.text.value;
      it.textSize = px(ed.textSize.value);
      it.color = ed.color.value || '#ffffff';
      it.textX = px(ed.textX.value);
      it.textY = px(ed.textY.value);
      it.iconScale = px(ed.iconScale.value);
      it.iconX = px(ed.iconX.value);
      it.iconY = px(ed.iconY.value);
      it.overlay = it.overlay || {};
      it.overlay.scale = px(ed.ovScale.value);
      it.overlay.x = px(ed.ovX.value);
      it.overlay.y = px(ed.ovY.value);
      it.showTextPreview = !!ed.textPreview.checked;
      render();
    };
    ['input','change'].forEach(ev => {
      ed.text.addEventListener(ev, upd);
      ed.textSize.addEventListener(ev, upd);
      ed.color.addEventListener(ev, upd);
      ed.textX.addEventListener(ev, upd);
      ed.textY.addEventListener(ev, upd);
      ed.iconScale.addEventListener(ev, upd);
      ed.iconX.addEventListener(ev, upd);
      ed.iconY.addEventListener(ev, upd);
      ed.ovScale.addEventListener(ev, upd);
      ed.ovX.addEventListener(ev, upd);
      ed.ovY.addEventListener(ev, upd);
      ed.textPreview.addEventListener(ev, upd);
    });
    ed.ovFile.addEventListener('change', async (e) => {
      if(editingIndex<0) return;
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      picked[editingIndex].overlay = picked[editingIndex].overlay || {};
      picked[editingIndex].overlay.url = url;
      render();
    });
    ed.del.addEventListener('click', () => {
      if(editingIndex<0) return;
      picked.splice(editingIndex,1);
      editingIndex=-1;
      slotEditorWrap.classList.add('hidden');
      renderPickedBar();
      render();
    });
  }

  // ===== background & fonts =====
  el('bgFile').addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      bgImg = await createImageBitmap(f);
      bgInfo.textContent = `背景: ${bgImg.width}×${bgImg.height}`;
    }catch{ bgImg = null; bgInfo.textContent = ''; }
    render();
  });

  const fontSel = el('fontSel');
  el('fontFile').addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    const fam = 'user-font-'+Date.now();
    const face = new FontFace(fam, `url(${url})`);
    await face.load();
    if (document.fonts && document.fonts.add) { document.fonts.add(face); }
    const style = document.createElement('style');
    style.textContent = `@font-face{ font-family:${fam}; src:url(${url}); font-display:swap; }`;
    document.head.appendChild(style);
    userFont = {name:fam, url};
    const opt = document.createElement('option');
    opt.value = fam; opt.textContent = f.name || fam;
    fontSel.appendChild(opt);
    fontSel.value = fam;
    render();
  });
  fontSel.addEventListener('change', () => {
    const v = fontSel.value;
    if(v === 'system-ui'){ userFont = null; }
    else { userFont = {name:v}; }
    render();
  });

  // ===== events =====
  el('loadBtn').addEventListener('click', async () => {
    try{
      gifts = await loadSheet(sheetId.value.trim(), gid.value.trim());
      renderGiftList();
    }catch(e){
      console.error(e);
      alert('読み込みに失敗しました。シェア設定やURL/プロキシを確認してください。\\n公開CSVが使えると最も安定します。');
    }
  });

  [cols,rows,tileW,tileH,gap,radius,offX,offY].forEach(x => x.addEventListener('input', () => render()));
  zoom.addEventListener('input', () => render());
  refreshBtn.addEventListener('click', () => render());
  showTextPreview.addEventListener('change', () => render());

  el('clearBtn').addEventListener('click', () => {
    picked = []; editingIndex=-1;
    slotEditorWrap.classList.add('hidden');
    renderPickedBar(); render();
  });

  el('saveBtn').addEventListener('click', async () => {
    const {W,H} = gridSize();
    let expW = W, expH = H;
    if(bgImg){ expW = bgImg.width; expH = bgImg.height; }
    else { expW = 1080; expH = Math.round(1080 * (H/W)); }
    exportCanvas.width = expW; exportCanvas.height = expH;
    const ctx = exportCanvas.getContext('2d');
    ctx.fillStyle='#0b1320'; ctx.fillRect(0,0,expW,expH);
    const s = expW / W;
    ctx.save();
    ctx.scale(s, s);
    if(bgImg){ ctx.drawImage(bgImg, 0,0, W,H); }

    const COLS = px(cols.value), TW = px(tileW.value), TH = px(tileH.value), GAP = px(gap.value);
    for(let i=0;i<Math.min(picked.length, COLS*px(rows.value)); i++){
      const r = Math.floor(i/COLS), c = i%COLS;
      const x = px(offX.value) + GAP + c*(TW+GAP);
      const y = px(offY.value) + GAP + r*(TH+GAP);
      const it = picked[i];
      if(!it) continue;

      try{
        const bmp = await fetchImageBitmap(it.gift.imageUrl, proxy.value.trim());
        const scalePct = (Number(it.iconScale)||100)/100;
        const maxW = TW - 16, maxH = TH - 16;
        const ratio = Math.min(maxW/bmp.width, maxH/bmp.height) * scalePct;
        const iw = bmp.width * ratio, ih = bmp.height * ratio;
        const ix = x + (TW - iw)/2 + px(it.iconX);
        const iy = y + (TH - ih)/2 + px(it.iconY);
        ctx.drawImage(bmp, ix, iy, iw, ih);
      }catch{}

      if(it.overlay && it.overlay.url){
        try{
          const img = await (async () => {
            if(imageCache.has(it.overlay.url)) return imageCache.get(it.overlay.url);
            const p = createImageBitmap(await (await fetch(it.overlay.url)).blob());
            imageCache.set(it.overlay.url, p);
            return p;
          })();
          const sc = (Number(it.overlay.scale)||100)/100;
          const iw = img.width * sc, ih = img.height * sc;
          const ix = x + (TW - iw)/2 + px(it.overlay.x);
          const iy = y + (TH - ih)/2 + px(it.overlay.y);
          ctx.drawImage(img, ix, iy, iw, ih);
        }catch{}
      }

      if(it.text){
        ctx.save();
        ctx.fillStyle = it.color || '#ffffff';
        ctx.strokeStyle = 'rgba(0,0,0,.9)';
        ctx.lineWidth = Math.max(2, Math.floor((Number(it.textSize)||86)/16));
        ctx.font = `900 ${Math.max(12, Number(it.textSize)||86)}px ${userFont ? userFont.name : 'system-ui'}`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const tx = x + TW/2 + px(it.textX);
        const ty = y + TH/2 + px(it.textY);
        ctx.strokeText(it.text, tx, ty);
        ctx.fillText(it.text, tx, ty);
        ctx.restore();
      }
    }
    ctx.restore();

    try{
      const url = exportCanvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'gift_board.png'; a.click();
    }catch{
      alert('PNG出力に失敗しました');
    }
  });

  // init
  function init(){
    bindEditor();
    render();
  }
  init();
})();
</script>
</body>
</html>
